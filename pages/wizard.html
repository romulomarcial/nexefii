<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    .progress-container {
      margin-bottom: 3rem;
    }

    @media (max-width: 768px) {
      .progress-container {
        margin-bottom: 2rem;
      }
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      position: relative;
    }

    @media (max-width: 480px) {
      .progress-steps {
        overflow-x: auto;
        justify-content: flex-start;
        gap: 2rem;
        padding-bottom: 0.5rem;
      }
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #E0E0E0;
      z-index: 0;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      position: relative;
      z-index: 1;
      flex: 1;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 2px solid #E0E0E0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #999;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .step-circle.active {
      background: #E42121;
      border-color: #E42121;
      color: white;
      transform: scale(1.15);
      box-shadow: 0 4px 12px rgba(228, 33, 33, 0.4);
      animation: pulse 2s ease-in-out infinite;
    }

    .step-circle.completed {
      background: #28A745;
      border-color: #28A745;
      color: white;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 4px 12px rgba(228, 33, 33, 0.4); }
      50% { box-shadow: 0 4px 20px rgba(228, 33, 33, 0.6); }
    }

    .step-circle.completed {
      background: #28A745;
      border-color: #28A745;
      color: white;
    }

    .step-label {
      font-size: 0.75rem;
      color: #999;
      text-align: center;
    }

    @media (max-width: 480px) {
      .step-label {
        font-size: 0.65rem;
        white-space: nowrap;
      }
    }

    .step-label.active {
      color: #E42121;
      font-weight: 600;
    }

    /* Form Container */
    .wizard-content {
      background: white;
      border: 1px solid #E0E0E0;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      min-height: 400px;
    }

    @media (max-width: 768px) {
      .wizard-content {
        padding: 1.5rem;
        border-radius: 8px;
      }
    }

    @media (max-width: 480px) {
      .wizard-content {
        padding: 1rem;
        border-radius: 4px;
        min-height: 300px;
      }
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
      animation: slideInFromRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .step-content.prev {
      animation: slideInFromLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInFromRight {
      from { 
        opacity: 0; 
        transform: translateX(30px);
      }
      to { 
        opacity: 1; 
        transform: translateX(0);
      }
    }

    @keyframes slideInFromLeft {
      from { 
        opacity: 0; 
        transform: translateX(-30px);
      }
      to { 
        opacity: 1; 
        transform: translateX(0);
      }
    }

    .step-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1A1A1A;
      margin-bottom: 1.5rem;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: #1A1A1A;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .form-label.required::after {
      content: '*';
      color: #E42121;
      margin-left: 0.25rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #E0E0E0;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #E42121;
    }

    .form-input.error,
    .form-select.error {
      border-color: #DC3545;
    }

    .form-error {
      color: #DC3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }

    .form-error.show {
      display: block;
    }

    .form-hint {
      color: #999;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Icon Selector */
    .icon-selector {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    @media (max-width: 768px) {
      .icon-selector {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    @media (max-width: 480px) {
      .icon-selector {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.3rem;
      }
    }

    .icon-option {
      width: 50px;
      height: 50px;
      border: 2px solid #E0E0E0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .icon-option:hover {
      border-color: #E42121;
      transform: scale(1.1);
    }

    .icon-option.selected {
      border-color: #E42121;
      background: #FFF5F5;
    }

    /* Image Upload Section */
    .image-upload-section {
      margin-top: 0.5rem;
    }

    .image-upload-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #E0E0E0;
    }

    .image-tab {
      background: none;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }

    .image-tab:hover {
      color: #E42121;
    }

    .image-tab.active {
      color: #E42121;
      border-bottom-color: #E42121;
    }

    .image-tab-content {
      display: none;
    }

    .image-tab-content.active {
      display: block;
    }

    .image-gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      padding: 1rem 0;
    }

    @media (max-width: 768px) {
      .image-gallery {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .image-gallery {
        grid-template-columns: 1fr;
      }
    }

    .gallery-image {
      position: relative;
      aspect-ratio: 16/9;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }

    .gallery-image:hover {
      border-color: #E42121;
      transform: scale(1.05);
    }

    .gallery-image.selected {
      border-color: #E42121;
    }

    .gallery-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-overlay {
      position: absolute;
      /* place the badge slightly inset from the corner so it doesn't clip */
      top: 8px;
      right: 8px;
      background: #E42121;
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.9rem;
      line-height: 1;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.18s, transform 0.18s;
    }

    .gallery-image.selected .gallery-overlay {
      opacity: 1;
      transform: scale(1);
    }

    .upload-area {
      padding: 2rem;
      border: 2px dashed #E0E0E0;
      border-radius: 8px;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: #E42121;
      background: #FFF5F5;
      transform: scale(1.02);
    }

    .upload-area.drag-over {
      border-color: #E42121;
      background: #FFF5F5;
      border-style: solid;
      box-shadow: 0 4px 12px rgba(228, 33, 33, 0.2);
      transform: scale(1.03);
    }

    .upload-label {
      cursor: pointer;
      display: block;
    }

    .upload-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }

    .upload-text {
      font-weight: 600;
      color: #1A1A1A;
      margin-bottom: 0.25rem;
    }

    .upload-hint {
      font-size: 0.875rem;
      color: #666;
    }

    .upload-loading {
      display: none;
      margin-top: 1rem;
    }

    .upload-loading.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      color: #E42121;
      font-weight: 600;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid #FFF5F5;
      border-top-color: #E42121;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .upload-preview {
      margin-top: 1rem;
      display: none;
    }

    .upload-preview.show {
      display: block;
    }

    .upload-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
    }

    .btn-preview {
      margin-top: 1rem;
      padding: 0.5rem 1.5rem;
      background: #E42121;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-preview:hover {
      background: #C11919;
    }

    /* Room Category Cards */
    .category-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .category-card {
      background: #F8F9FA;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      padding: 1rem;
      position: relative;
    }

    .category-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .category-name {
      font-weight: 600;
      color: #1A1A1A;
    }

    .btn-remove {
      background: #DC3545;
      color: white;
      border: none;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .btn-remove:hover {
      background: #C82333;
    }

    /* Templates */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .template-card {
      background: white;
      border: 2px solid #E0E0E0;
      border-radius: 8px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .template-card:hover {
      border-color: #E42121;
      box-shadow: 0 4px 12px rgba(228, 33, 33, 0.15);
    }

    .template-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }

    .template-name {
      font-weight: 600;
      color: #1A1A1A;
      margin-bottom: 0.5rem;
    }

    .template-desc {
      font-size: 0.875rem;
      color: #666;
    }

    /* Review Section */
    .review-section {
      background: #F8F9FA;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .review-section-title {
      font-weight: 600;
      color: #1A1A1A;
      margin-bottom: 1rem;
      font-size: 1.125rem;
    }

    .review-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #E0E0E0;
    }

    .review-item:last-child {
      border-bottom: none;
    }

    .review-label {
      color: #666;
      font-size: 0.875rem;
    }

    .review-value {
      font-weight: 600;
      color: #1A1A1A;
    }

    .review-image-preview {
      margin: 1rem 0 1.5rem;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .review-image-preview img {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      display: block;
    }

    /* Buttons */
    .wizard-actions {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }

    .btn {
      padding: 0.75rem 2rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 1rem;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:active::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: #E42121;
      color: white;
      box-shadow: 0 2px 8px rgba(228, 33, 33, 0.2);
    }

    .btn-primary:hover {
      background: #C41A1A;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(228, 33, 33, 0.3);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      background: #CCC;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: #6C757D;
      color: white;
      box-shadow: 0 2px 8px rgba(108, 117, 125, 0.2);
    }

    .btn-secondary:hover {
      background: #5A6268;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }

    .btn-secondary:active {
      transform: translateY(0);
    }

    .btn-success {
      background: #28A745;
      color: white;
      font-size: 1.125rem;
      padding: 1rem 3rem;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
    }

    .btn-success:active {
      transform: translateY(0);
    }

    .btn-success:hover {
      background: #218838;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .modules-checkboxes {
      margin: 1.5rem 0;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 2rem;
    }

    .module-checkbox {
      font-size: 1rem;
      font-weight: 500;
      color: #333;
      background: #f7f7f7;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .module-checkbox input[type="checkbox"] {
      margin-right: 0.5rem;
      accent-color: #E42121;
    }

    .module-checkbox:hover {
      background: #eaeaea;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .template-grid {
        grid-template-columns: 1fr;
      }

      .icon-selector {
        grid-template-columns: repeat(6, 1fr);
      }

      .modules-checkboxes {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body class="wizard-page">

  <!-- Wizard Header -->
  <div class="wizard-header">
    <h1 class="wizard-title" data-i18n="wizard.title"></h1>
    <p class="wizard-subtitle" data-i18n="wizard.subtitle"></p>
  </div>

  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-steps" id="progress-steps">
      <div class="progress-step">
        <div class="step-circle active">1</div>
        <div class="step-label active" data-i18n="wizard.labels.basic"></div>
      </div>
      <div class="progress-step">
        <div class="step-circle">2</div>
  <div class="step-label" data-i18n="wizard.labels.details">Detalhes</div>
      </div>
      <div class="progress-step">
        <div class="step-circle">3</div>
  <div class="step-label" data-i18n="wizard.labels.modules">M√≥dulos</div>
      </div>
      <div class="progress-step">
        <div class="step-circle">4</div>
  <div class="step-label" data-i18n="wizard.labels.rooms">Quartos</div>
      </div>
      <div class="progress-step">
        <div class="step-circle">5</div>
  <div class="step-label" data-i18n="wizard.labels.config">Config</div>
      </div>
      <div class="progress-step">
        <div class="step-circle">6</div>
  <div class="step-label" data-i18n="wizard.labels.data">Dados</div>
      </div>
      <div class="progress-step">
        <div class="step-circle">7</div>
  <div class="step-label" data-i18n="wizard.labels.review">Revis√£o</div>
      </div>
    </div>
  </div>

  <!-- Wizard Content -->
  <div class="wizard-content">
    <!-- Step 1: Basic Info -->
    <div class="step-content active" id="step-1">
  <h2 class="step-title" data-i18n="wizard.step1.title">Informa√ß√µes B√°sicas</h2>
      
      <div class="form-group">
  <label class="form-label required" data-i18n="wizard.step1.name">Nome da Propriedade</label>
  <input type="text" class="form-input" id="name" data-i18n="wizard.step1.namePlaceholder" placeholder="Ex: Hotel Para√≠so">
        <div class="form-error" id="error-name"></div>
  <div class="form-hint" data-i18n="wizard.step1.nameHint">O nome que aparecer√° no sistema</div>
      </div>

      <div class="form-group">
  <label class="form-label required" data-i18n="wizard.step1.slugLabel">Slug (URL)</label>
  <input type="text" class="form-input" id="slug" data-i18n="wizard.step1.slugPlaceholder" placeholder="hotel-paraiso" readonly>
        <div class="form-error" id="error-slug"></div>
  <div class="form-hint" data-i18n="wizard.step1.slugHint">Gerado automaticamente a partir do nome</div>
      </div>

      <div class="form-group">
  <label class="form-label" data-i18n="wizard.step1.description">Descri√ß√£o</label>
  <textarea class="form-textarea" id="description" rows="3" data-i18n="wizard.step1.descriptionPlaceholder" placeholder="Descri√ß√£o breve da propriedade"></textarea>
      </div>

      <div class="form-group">
  <label class="form-label required" data-i18n="wizard.step1.iconLabel">√çcone</label>
        <div class="icon-selector">
          <!-- Icon list rendered once; duplicates removed -->
          <div class="icon-option" data-icon="üè®">üè®</div>
          <div class="icon-option" data-icon="üè©">üè©</div>
          <div class="icon-option" data-icon="üè¢">üè¢</div>
          <div class="icon-option" data-icon="üõéÔ∏è">üõéÔ∏è</div>
          <div class="icon-option" data-icon="üõèÔ∏è">üõèÔ∏è</div>
          <div class="icon-option" data-icon="üèùÔ∏è">üèùÔ∏è</div>
          <div class="icon-option" data-icon="üèñÔ∏è">üèñÔ∏è</div>
          <div class="icon-option" data-icon="üè°">üè°</div>
          <div class="icon-option" data-icon="üè†">üè†</div>
          <div class="icon-option" data-icon="üèïÔ∏è">üèïÔ∏è</div>
          <div class="icon-option" data-icon="üèØ">üèØ</div>
          <div class="icon-option" data-icon="üñºÔ∏è">üñºÔ∏è</div>
          <div class="icon-option" data-icon="üåê">üåê</div>
          <div class="icon-option" data-icon="üß≠">üß≠</div>
          <div class="icon-option" data-icon="üó∫Ô∏è">üó∫Ô∏è</div>
          <div class="icon-option" data-icon="üì∂">üì∂</div>
        </div>
        <div class="form-error" id="error-icon"></div>
      </div>

      <div class="form-group">
  <label class="form-label" data-i18n="wizard.step1.imageLabel">Imagem da Propriedade</label>
        <div class="image-upload-section">
          <div class="image-upload-tabs">
            <button type="button" class="image-tab active" data-tab="gallery" data-i18n="wizard.image.tabs.gallery">Galeria</button>
            <button type="button" class="image-tab" data-tab="upload" data-i18n="wizard.image.tabs.upload">Upload</button>
            <button type="button" class="image-tab" data-tab="url" data-i18n="wizard.image.tabs.url">URL</button>
          </div>

          <!-- Gallery Tab -->
          <div class="image-tab-content active" id="gallery-tab">
            <div class="image-gallery">
              <div class="gallery-image selected" data-image="/assets/images/default-hotel-1.jpg">
                <img loading="lazy" decoding="async" src="/assets/images/default-hotel-1.jpg" alt="Hotel Moderno" onerror="this.onerror=null;this.src='/assets/Nexefii_logo_3d-official.png'">
                <div class="gallery-overlay">‚úì</div>
              </div>
              <div class="gallery-image" data-image="/assets/images/default-hotel-2.jpg">
                <img loading="lazy" decoding="async" src="/assets/images/default-hotel-2.jpg" alt="Resort Praia" onerror="this.onerror=null;this.src='/assets/Nexefii_logo_3d-official.png'">
                <div class="gallery-overlay">‚úì</div>
              </div>
              <div class="gallery-image" data-image="/assets/images/default-hotel-3.jpg">
                <img loading="lazy" decoding="async" src="/assets/images/default-hotel-3.jpg" alt="Hotel Urbano" onerror="this.onerror=null;this.src='/assets/Nexefii_logo_3d-official.png'">
                <div class="gallery-overlay">‚úì</div>
              </div>
              <div class="gallery-image" data-image="/assets/images/default-hotel-4.jpg">
                <img loading="lazy" decoding="async" src="/assets/images/default-hotel-4.jpg" alt="Pousada" onerror="this.onerror=null;this.src='/assets/Nexefii_logo_3d-official.png'">
                <div class="gallery-overlay">‚úì</div>
              </div>
              <div class="gallery-image" data-image="/assets/images/default-hotel-5.jpg">
                <img loading="lazy" decoding="async" src="/assets/images/default-hotel-5.jpg" alt="Hotel Boutique" onerror="this.onerror=null;this.src='/assets/Nexefii_logo_3d-official.png'">
                <div class="gallery-overlay">‚úì</div>
              </div>
              <div class="gallery-image" data-image="/assets/images/default-hotel-6.jpg">
                <img loading="lazy" decoding="async" src="/assets/images/default-hotel-6.jpg" alt="Resort Montanha" onerror="this.onerror=null;this.src='/assets/Nexefii_logo_3d-official.png'">
                <div class="gallery-overlay">‚úì</div>
              </div>
            </div>
          </div>

          <!-- Upload Tab -->
          <div class="image-tab-content" id="upload-tab">
              <div class="upload-area">
              <input type="file" id="image-file" accept="image/*" style="display: none;">
              <label for="image-file" class="upload-label">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text" data-i18n="wizard.image.upload.text">Clique para selecionar ou arraste uma imagem</div>
                <div class="upload-hint" data-i18n="wizard.image.upload.hint">JPG, PNG ou WEBP at√© 5MB</div>
              </label>
              <div id="upload-preview" class="upload-preview"></div>
              <div id="upload-loading" class="upload-loading">
                <div class="spinner"></div>
                <span data-i18n="wizard.image.upload.processing">Processando imagem...</span>
              </div>
            </div>
          </div>

          <!-- URL Tab -->
          <div class="image-tab-content" id="url-tab">
            <input type="url" class="form-input" id="image-url" data-i18n="wizard.image.url.placeholder" placeholder="https://exemplo.com/imagem.jpg">
            <div id="url-preview" class="upload-preview"></div>
            <button type="button" class="btn-preview" id="btn-preview-url" data-i18n="wizard.image.url.previewButton">Pr√©-visualizar</button>
          </div>

          <!-- Hidden field stores selected image path (always absolute from root) -->
          <input type="hidden" id="propertyImage" value="/assets/images/default-hotel-1.jpg">
        </div>
      </div>
    </div>

    <!-- Step 2: Property Details -->
    <div class="step-content" id="step-2">
  <h2 class="step-title" data-i18n="wizard.details.title">Detalhes da Propriedade</h2>

      <div class="form-group">
  <label class="form-label required" data-i18n="wizard.details.typeLabel">Tipo</label>
        <select class="form-select" id="type">
          <option value="hotel" data-i18n="wizard.details.types.hotel">Hotel</option>
          <option value="resort" data-i18n="wizard.details.types.resort">Resort</option>
          <option value="hostel" data-i18n="wizard.details.types.hostel">Hostel</option>
          <option value="pousada" data-i18n="wizard.details.types.pousada">Pousada</option>
        </select>
        <div class="form-error" id="error-type"></div>
      </div>

      <div class="form-group">
  <label class="form-label required" data-i18n="wizard.details.totalRoomsLabel">N√∫mero Total de Quartos</label>
  <input type="number" class="form-input" id="roomsCount" data-i18n="wizard.step4.roomsPlaceholder" placeholder="Ex: 50" min="1" max="1000">
        <div class="form-error" id="error-roomsCount"></div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label" data-i18n="wizard.details.cityLabel">Cidade</label>
          <input type="text" class="form-input" id="city" data-i18n="wizard.step2.cityPlaceholder" placeholder="S√£o Paulo">
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="wizard.details.stateLabel">Estado</label>
          <input type="text" class="form-input" id="state" data-i18n="wizard.step2.statePlaceholder" placeholder="SP">
        </div>
      </div>

      <div class="form-group">
  <label class="form-label" data-i18n="wizard.details.addressLabel">Endere√ßo</label>
  <input type="text" class="form-input" id="street" data-i18n="wizard.step2.addressPlaceholder" placeholder="Rua, n√∫mero">
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label" data-i18n="wizard.details.zipLabel">CEP</label>
          <input type="text" class="form-input" id="zip" data-i18n="wizard.details.zipLabel" placeholder="00000-000">
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="wizard.details.countryLabel">Pa√≠s</label>
          <input type="text" class="form-input" id="country" value="Brasil">
        </div>
      </div>
    </div>

    <!-- Step 2.5: Module Selection -->
    <div class="step-content" id="step-modules">
  <h2 class="step-title" data-i18n="wizard.modules.title">M√≥dulos da Propriedade</h2>
    <p style="color: #666; margin-bottom: 1.5rem;" data-i18n="wizard.modules.subtitle">Selecione os m√≥dulos que deseja ativar/vender para esta propriedade:</p>
      <div class="modules-checkboxes">
        <label class="module-checkbox"><input type="checkbox" id="module-ems" value="EMS"> <span data-i18n="wizard.modules.ems">EMS (Energy Management)</span></label><br>
        <label class="module-checkbox"><input type="checkbox" id="module-bms" value="BMS"> <span data-i18n="wizard.modules.bms">BMS (Building Management)</span></label><br>
  <label class="module-checkbox"><input type="checkbox" id="module-automation" value="Automation"> <span data-i18n="wizard.modules.automation">Automa√ß√£o</span></label><br>
        <label class="module-checkbox"><input type="checkbox" id="module-analytics" value="Analytics"> <span data-i18n="wizard.modules.analytics">Analytics</span></label><br>
        <label class="module-checkbox"><input type="checkbox" id="module-pms" value="PMS"> <span data-i18n="wizard.modules.pms">PMS (Property Management)</span></label><br>
        <label class="module-checkbox"><input type="checkbox" id="module-iot" value="IoT"> <span data-i18n="wizard.modules.iot">IoT Devices</span></label><br>
        <label class="module-checkbox"><input type="checkbox" id="module-access" value="Access"> <span data-i18n="wizard.modules.access">Controle de Acesso</span></label><br>
        <label class="module-checkbox"><input type="checkbox" id="module-other" value="Other"> <span data-i18n="wizard.modules.other">Outros</span></label>
      </div>
    </div>

    <!-- Step 3: Room Configuration -->
    <div class="step-content" id="step-3">
  <h2 class="step-title" data-i18n="wizard.rooms.title">Configura√ß√£o de Quartos</h2>

      <p style="color: #666; margin-bottom: 1.5rem;">
        <span data-i18n="wizard.rooms.subtitle">Configure as categorias de quartos. O total deve ser igual a</span> <strong id="total-rooms-needed">0</strong> <span data-i18n="wizard.rooms.roomsLabel">quartos</span>.
      </p>

      <div class="template-grid">
        <div class="template-card" onclick="applyTemplate('small-hotel')">
          <div class="template-icon">üè®</div>
          <div class="template-name" data-i18n="wizard.rooms.templates.smallHotel.name">Hotel Pequeno</div>
          <div class="template-desc" data-i18n="wizard.rooms.templates.smallHotel.desc">20 quartos (3 categorias)</div>
        </div>
        <div class="template-card" onclick="applyTemplate('medium-hotel')">
          <div class="template-icon">üè©</div>
          <div class="template-name" data-i18n="wizard.rooms.templates.mediumHotel.name">Hotel M√©dio</div>
          <div class="template-desc" data-i18n="wizard.rooms.templates.mediumHotel.desc">50 quartos (3 categorias)</div>
        </div>
        <div class="template-card" onclick="applyTemplate('resort')">
          <div class="template-icon">üèùÔ∏è</div>
          <div class="template-name" data-i18n="wizard.rooms.templates.resort.name">Resort</div>
          <div class="template-desc" data-i18n="wizard.rooms.templates.resort.desc">100 quartos (4 categorias)</div>
        </div>
        <div class="template-card" onclick="applyTemplate('hostel')">
          <div class="template-icon">üõå</div>
          <div class="template-name" data-i18n="wizard.rooms.templates.hostel.name">Hostel</div>
          <div class="template-desc" data-i18n="wizard.rooms.templates.hostel.desc">30 quartos (3 categorias)</div>
        </div>
      </div>

      <div class="category-list" id="category-list">
        <!-- Categories rendered here -->
      </div>

      <div class="form-error show" id="error-roomCategories"></div>
      <div class="form-error show" id="error-totalRooms"></div>

  <button class="btn btn-secondary" onclick="addCategory()" data-i18n="wizard.rooms.addCategory">+ Adicionar Categoria</button>
    </div>

    <!-- Step 4: Settings -->
    <div class="step-content" id="step-4">
  <h2 class="step-title" data-i18n="wizard.config.title">Configura√ß√µes</h2>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label required" data-i18n="wizard.config.currencyLabel">Moeda</label>
          <select class="form-select" id="currency">
            <option value="BRL">BRL - Real Brasileiro (R$)</option>
            <option value="USD">USD - D√≥lar Americano ($)</option>
            <option value="EUR">EUR - Euro (‚Ç¨)</option>
            <option value="GBP">GBP - Libra Esterlina (¬£)</option>
            <option value="CAD">CAD - D√≥lar Canadense (C$)</option>
            <option value="AUD">AUD - D√≥lar Australiano (A$)</option>
            <option value="MXN">MXN - Peso Mexicano (MX$)</option>
            <option value="ARS">ARS - Peso Argentino (AR$)</option>
            <option value="COP">COP - Peso Colombiano (COL$)</option>
            <option value="CLP">CLP - Peso Chileno (CLP$)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label required" data-i18n="wizard.config.timezoneLabel">Fuso Hor√°rio</label>
          <select class="form-select" id="timezone">
            <!-- Americas -->
            <optgroup label="üåé Am√©ricas" data-i18n="wizard.config.timezoneGroups.americas">
              <option value="America/New_York">Nova York (UTC-5)</option>
              <option value="America/Los_Angeles">Los Angeles (UTC-8)</option>
              <option value="America/Chicago">Chicago (UTC-6)</option>
              <option value="America/Denver">Denver (UTC-7)</option>
              <option value="America/Toronto">Toronto (UTC-5)</option>
              <option value="America/Sao_Paulo" selected>S√£o Paulo (UTC-3)</option>
              <option value="America/Manaus">Manaus (UTC-4)</option>
              <option value="America/Rio_Branco">Rio Branco (UTC-5)</option>
              <option value="America/Fortaleza">Fortaleza (UTC-3)</option>
              <option value="America/Buenos_Aires">Buenos Aires (UTC-3)</option>
              <option value="America/Santiago">Santiago (UTC-3)</option>
              <option value="America/Lima">Lima (UTC-5)</option>
              <option value="America/Bogota">Bogot√° (UTC-5)</option>
              <option value="America/Mexico_City">Cidade do M√©xico (UTC-6)</option>
              <option value="America/Caracas">Caracas (UTC-4)</option>
            </optgroup>
            <!-- Europe -->
            <optgroup label="üåç Europa" data-i18n="wizard.config.timezoneGroups.europe">
              <option value="Europe/London">Londres (UTC+0)</option>
              <option value="Europe/Paris">Paris (UTC+1)</option>
              <option value="Europe/Berlin">Berlim (UTC+1)</option>
              <option value="Europe/Madrid">Madri (UTC+1)</option>
              <option value="Europe/Rome">Roma (UTC+1)</option>
              <option value="Europe/Amsterdam">Amsterd√£ (UTC+1)</option>
              <option value="Europe/Brussels">Bruxelas (UTC+1)</option>
              <option value="Europe/Zurich">Zurique (UTC+1)</option>
              <option value="Europe/Lisbon">Lisboa (UTC+0)</option>
              <option value="Europe/Moscow">Moscou (UTC+3)</option>
            </optgroup>
            <!-- Asia & Pacific -->
            <optgroup label="üåè √Åsia & Pac√≠fico" data-i18n="wizard.config.timezoneGroups.asiaPacific">
              <option value="Asia/Tokyo">T√≥quio (UTC+9)</option>
              <option value="Asia/Shanghai">Xangai (UTC+8)</option>
              <option value="Asia/Hong_Kong">Hong Kong (UTC+8)</option>
              <option value="Asia/Singapore">Singapura (UTC+8)</option>
              <option value="Asia/Seoul">Seul (UTC+9)</option>
              <option value="Asia/Dubai">Dubai (UTC+4)</option>
              <option value="Asia/Bangkok">Bangkok (UTC+7)</option>
              <option value="Asia/Kolkata">Mumbai (UTC+5:30)</option>
              <option value="Australia/Sydney">Sydney (UTC+10)</option>
              <option value="Australia/Melbourne">Melbourne (UTC+10)</option>
              <option value="Pacific/Auckland">Auckland (UTC+12)</option>
            </optgroup>
            <!-- Africa & Middle East -->
            <optgroup label="üåç √Åfrica & Oriente M√©dio" data-i18n="wizard.config.timezoneGroups.africaMiddleEast">
              <option value="Africa/Cairo">Cairo (UTC+2)</option>
              <option value="Africa/Johannesburg">Joanesburgo (UTC+2)</option>
              <option value="Africa/Lagos">Lagos (UTC+1)</option>
              <option value="Asia/Jerusalem">Jerusal√©m (UTC+2)</option>
              <option value="Asia/Istanbul">Istambul (UTC+3)</option>
            </optgroup>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label required" data-i18n="wizard.config.checkInLabel">Hor√°rio Check-in</label>
          <input type="time" class="form-input" id="checkInTime" value="14:00">
        </div>

        <div class="form-group">
          <label class="form-label required" data-i18n="wizard.config.checkOutLabel">Hor√°rio Check-out</label>
          <input type="time" class="form-input" id="checkOutTime" value="12:00">
        </div>
      </div>

      <div class="form-group">
  <label class="form-label" data-i18n="wizard.config.languageLabel">Idioma</label>
        <select class="form-select" id="language">
          <option value="pt-BR">Portugu√™s (Brasil)</option>
          <option value="en-US">English (US)</option>
          <option value="es-ES">Espa√±ol</option>
        </select>
      </div>
    </div>

    <!-- Step 5: Seed Data -->
    <div class="step-content" id="step-5">
  <h2 class="step-title" data-i18n="wizard.seed.title">Dados Iniciais</h2>

      <p style="color: #666; margin-bottom: 2rem;">
        Escolha quais dados de exemplo voc√™ quer que sejam criados automaticamente:
      </p>

      <div class="checkbox-group">
        <input type="checkbox" class="checkbox" id="createSampleRooms" checked>
        <label for="createSampleRooms">
          <strong data-i18n="wizard.seed.roomsExampleTitle">Criar quartos de exemplo</strong><br>
          <span style="font-size: 0.875rem; color: #666;">
            <span data-i18n="wizard.seed.roomsExampleDesc">Cria automaticamente todos os quartos conforme as categorias configuradas</span>
          </span>
        </label>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" class="checkbox" id="createSampleGuests" checked>
        <label for="createSampleGuests">
          <strong data-i18n="wizard.seed.guestsExampleTitle">Criar h√≥spedes de exemplo</strong><br>
          <span style="font-size: 0.875rem; color: #666;">
            <span data-i18n="wizard.seed.guestsExampleDesc">Adiciona 3 h√≥spedes fict√≠cios para testes</span>
          </span>
        </label>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" class="checkbox" id="createSampleReservations">
        <label for="createSampleReservations">
          <strong data-i18n="wizard.seed.reservationExampleTitle">Criar reserva de exemplo</strong><br>
          <span style="font-size: 0.875rem; color: #666;">
            <span data-i18n="wizard.seed.reservationExampleDesc">Cria 1 reserva confirmada para demonstra√ß√£o</span>
          </span>
        </label>
      </div>
    </div>

    <!-- Step 6: Review -->
    <div class="step-content" id="step-6">
  <h2 class="step-title" data-i18n="wizard.review.title" data-i18n-default="Revis√£o Final">Revis√£o Final</h2>

    <p style="color: #666; margin-bottom: 2rem;">
  <span data-i18n="wizard.review.subtitle" data-i18n-default="Revise as informa√ß√µes antes de criar a propriedade:">Revise as informa√ß√µes antes de criar a propriedade:</span>
    </p>

      <div class="review-section">
  <div class="review-section-title" data-i18n="wizard.review.basicInfo" data-i18n-default="Informa√ß√µes B√°sicas">Informa√ß√µes B√°sicas</div>
        <div class="review-item">
          <span class="review-label" data-i18n="wizard.review.imageLabel" data-i18n-default="Imagem da Propriedade">Imagem da Propriedade</span>
        </div>
        <div class="review-image-preview">
          <img id="review-image" src="/assets/images/default-hotel-1.jpg" alt="Imagem da propriedade" loading="lazy" decoding="async" onerror="this.onerror=null;this.src='/assets/Nexefii_logo_3d-official.png'">
        </div>
        <div class="review-item">
          <span class="review-label" data-i18n="wizard.review.nameLabel">Nome</span>
          <span class="review-value" id="review-name">-</span>
        </div>
        <div class="review-item">
          <span class="review-label" data-i18n="wizard.review.slugLabel">Slug</span>
          <span class="review-value" id="review-slug">-</span>
        </div>
        <div class="review-item">
          <span class="review-label" data-i18n="wizard.review.typeLabel">Tipo</span>
          <span class="review-value" id="review-type">-</span>
        </div>
        <div class="review-item">
          <span class="review-label" data-i18n="wizard.review.totalRoomsLabel">Total de Quartos</span>
          <span class="review-value" id="review-roomsCount">-</span>
        </div>
      </div>

      <div class="review-section">
  <div class="review-section-title" data-i18n="wizard.review.categoriesTitle">Categorias de Quartos</div>
        <div id="review-categories">
          <!-- Categories rendered here -->
        </div>
      </div>

      <div class="review-section">
      <div class="review-section-title" data-i18n="wizard.review.configTitle">Configura√ß√µes</div>
        <div class="review-item">
          <span class="review-label" data-i18n="wizard.config.currencyLabel">Moeda</span>
          <span class="review-value" id="review-currency">-</span>
        </div>
        <div class="review-item">
          <span class="review-label" data-i18n="wizard.review.checkTimesLabel">Check-in / Check-out</span>
          <span class="review-value" id="review-checktimes">-</span>
        </div>
      </div>

      <div class="review-section">
      <div class="review-section-title" data-i18n="wizard.review.modulesTitle">M√≥dulos Selecionados</div>
        <div id="review-modules">
          <!-- Modules rendered here -->
        </div>
      </div>

      <div style="text-align: center; margin-top: 3rem;">
        <button class="btn btn-success" onclick="createProperty()" id="btn-create">
          <span data-i18n="wizard.buttons.create">‚ú® Criar Propriedade</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Wizard Actions -->
  <div class="wizard-actions">
    <button class="btn btn-secondary" id="btn-prev" onclick="prevStep()" style="display: none;">
      ‚Üê <span data-i18n="wizard.buttons.back">Voltar</span>
    </button>
    <div style="flex: 1;"></div>
    <button class="btn btn-primary" id="btn-next" onclick="nextStep()">
      <span data-i18n="wizard.buttons.next">Pr√≥ximo</span> ‚Üí
    </button>
  </div>
</div>

  <!-- Core runtime dependencies (ensure page works standalone) -->
  <script src="../core/database/PropertyDatabase.js"></script>
  <script src="../core/i18n/I18nManager.js"></script>
  <script src="../core/wizard/WizardManager.js"></script>

<script>
  // Load i18n file (if available) and apply translations to elements with data-i18n
  async function loadPageI18n() {
    try {
      const res = await fetch('/i18n.json', { cache: 'no-store' });
      if (!res.ok) return;
      window.__PAGE_I18N = await res.json();
    } catch (e) {
      // ignore ‚Äî page will keep embedded texts
      window.__PAGE_I18N = window.__PAGE_I18N || {};
    }
  }

  function resolveI18nKey(path, lang) {
    try {
      if (!window.__PAGE_I18N) return null;
      const langObj = window.__PAGE_I18N[lang] || window.__PAGE_I18N[lang.split('-')[0]] || window.__PAGE_I18N['en'] || {};
      const parts = path.split('.');
      let cur = langObj;
      for (const p of parts) {
        if (cur && Object.prototype.hasOwnProperty.call(cur, p)) cur = cur[p];
        else return null;
      }
      return (typeof cur === 'string') ? cur : null;
    } catch (e) {
      return null;
    }
  }

  function applyI18nToPage(lang) {
    try {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const txt = resolveI18nKey(key, lang);
        if (txt) {
          // If element has placeholder attribute, set it instead of innerText for inputs
          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') {
            el.placeholder = txt;
          } else {
            el.innerText = txt;
          }
        }
      });
    } catch (e) {
      // ignore
    }
  }

  (async function initWizardPage(){
    // Prefer the core I18nManager when available (recommended). If not present, fall back to legacy monolithic loader.
    try {
      if (window.NEXEFII && window.NEXEFII.i18n && typeof window.NEXEFII.i18n.loadTranslations === 'function') {
        await window.NEXEFII.i18n.loadTranslations();
        window.NEXEFII.i18n.applyToDOM(document);
      } else {
        await loadPageI18n();
        const savedLang = (localStorage.getItem('nexefii_lang') || navigator.language || 'pt').split('-')[0];
        applyI18nToPage(savedLang);
      }
    } catch (e) {
      // continue even if i18n failed
      console.warn('[Wizard] i18n initialization issue', e?.message || e);
    }

    // Initialize Wizard Manager (idempotent / safe re-entry)
    if (typeof WizardManager === 'undefined') {
      console.error('[Wizard] WizardManager not loaded');
    }
    // Reuse existing instance if present to avoid redeclaration errors on re-navigation
    window.wizard = (window.wizard && window.wizard instanceof WizardManager)
      ? window.wizard
      : new WizardManager();
    wizard = window.wizard; // create global binding
  })();

  // ============================================================================
  // Step Navigation
  // ============================================================================

  function updateUI() {
    // Guard: ensure wizard is ready before updating the UI. Some inline handlers
    // or early DOM events may invoke updateUI before the async initializer finishes.
    if (typeof window.wizard === 'undefined' || window.wizard == null) return;
    const wizard = window.wizard;

    // Update progress steps
    const steps = document.querySelectorAll('.progress-step');
    steps.forEach((step, index) => {
      const stepNum = index + 1;
      const circle = step.querySelector('.step-circle');
      const label = step.querySelector('.step-label');

      if (stepNum < wizard.currentStep) {
        circle.classList.add('completed');
        circle.classList.remove('active');
        circle.textContent = '‚úì';
      } else if (stepNum === wizard.currentStep) {
        circle.classList.add('active');
        circle.classList.remove('completed');
        circle.textContent = stepNum;
        label.classList.add('active');
      } else {
        circle.classList.remove('active', 'completed');
        circle.textContent = stepNum;
        label.classList.remove('active');
      }
    });

    // Update step content visibility
    document.querySelectorAll('.step-content').forEach((content, index) => {
      // Step order: 1 (basic), 2 (details), modules, 3 (rooms), 4 (settings), 5 (seed), 6 (review)
      if (
        (wizard.currentStep === 1 && content.id === 'step-1') ||
        (wizard.currentStep === 2 && content.id === 'step-2') ||
        (wizard.currentStep === 3 && content.id === 'step-modules') ||
        (wizard.currentStep === 4 && content.id === 'step-3') ||
        (wizard.currentStep === 5 && content.id === 'step-4') ||
        (wizard.currentStep === 6 && content.id === 'step-5') ||
        (wizard.currentStep === 7 && content.id === 'step-6')
      ) {
        content.classList.add('active');
      } else {
        content.classList.remove('active');
      }
    });

    // Update buttons
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');

    btnPrev.style.display = wizard.isFirstStep() ? 'none' : 'block';
    if (window.NEXEFII?.i18n) {
      const label = wizard.isLastStep() ? window.NEXEFII.i18n.t('wizard.buttons.create') : window.NEXEFII.i18n.t('wizard.buttons.next');
      // Keep arrow with text, but don't break data-i18n spans
      const span = btnNext.querySelector('[data-i18n]');
      if (span) span.textContent = label;
    } else {
      btnNext.textContent = wizard.isLastStep() ? 'Concluir ‚Üí' : 'Pr√≥ximo ‚Üí';
    }
    btnNext.style.display = wizard.isLastStep() ? 'none' : 'block';

    // Update step-specific UI
    if (wizard.currentStep === 4) {
      document.getElementById('total-rooms-needed').textContent = wizard.data.roomsCount || 0;
      renderCategories();
    }

    if (wizard.currentStep === 7) {
      updateReview();
    }

    // Apply translations after DOM updates
    try { if (window.NEXEFII?.i18n) window.NEXEFII.i18n.applyToDOM(document.querySelector('.wizard-content')); } catch(e) { console.warn('[Wizard] i18n apply error', e); }
  }

  function nextStep() {
    if (wizard.nextStep()) {
      clearErrors();
      updateUI();
    } else {
      showErrors();
    }
  }

  function prevStep() {
    if (wizard.prevStep()) {
      clearErrors();
      updateUI();
    }
  }

  // Make functions globally accessible for onclick handlers
  window.nextStep = nextStep;
  window.prevStep = prevStep;
  // Expose room template/category functions for inline onclick handlers
  window.applyTemplate = applyTemplate;
  window.addCategory = addCategory;
  window.removeCategory = removeCategory;

  // ============================================================================
  // Form Handling
  // ============================================================================

  function clearErrors() {
    document.querySelectorAll('.form-error').forEach(el => {
      el.classList.remove('show');
      el.textContent = '';
    });
    document.querySelectorAll('.form-input, .form-select').forEach(el => {
      el.classList.remove('error');
    });
  }

  function showErrors() {
    const errors = wizard.getValidationErrors();
    
    for (const [field, message] of Object.entries(errors)) {
      const errorEl = document.getElementById(`error-${field}`);
      const inputEl = document.getElementById(field);
      
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.add('show');
      }
      
      if (inputEl) {
        inputEl.classList.add('error');
      }
    }
  }

  // Bind input events
  ['name', 'description', 'type', 'roomsCount', 'city', 'state', 'street', 'zip', 'country', 
   'currency', 'timezone', 'checkInTime', 'checkOutTime', 'language'].forEach(field => {
    const el = document.getElementById(field);
    if (el) {
      el.addEventListener('input', (e) => {
        const value = e.target.value;
        
        if (field === 'roomsCount') {
          wizard.updateData(field, parseInt(value) || 0);
        } else if (field.startsWith('address.')) {
          wizard.updateData(`address.${field.split('.')[1]}`, value);
        } else if (['city', 'state', 'street', 'zip', 'country'].includes(field)) {
          wizard.updateData(`address.${field}`, value);
        } else if (['currency', 'timezone', 'language', 'checkInTime', 'checkOutTime'].includes(field)) {
          wizard.updateData(`settings.${field}`, value);
        } else {
          wizard.updateData(field, value);
        }

        // Auto-update slug field
        if (field === 'name') {
          document.getElementById('slug').value = wizard.data.slug;
        }
      });
    }
  });

  // Icon selector
  document.querySelectorAll('.icon-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
      wizard.updateData('icon', option.dataset.icon);
    });
  });

  // Seed data checkboxes
  ['createSampleRooms', 'createSampleGuests', 'createSampleReservations'].forEach(field => {
    const el = document.getElementById(field);
    if (el) {
      el.addEventListener('change', (e) => {
        wizard.updateData(`seedData.${field}`, e.target.checked);
      });
    }
  });

  // Module selection checkboxes
  const moduleIds = [
    'module-ems', 'module-bms', 'module-automation', 'module-analytics',
    'module-pms', 'module-iot', 'module-access', 'module-other'
  ];
  moduleIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('change', () => {
        wizard.data.modules = moduleIds
          .filter(mid => document.getElementById(mid)?.checked)
          .map(mid => document.getElementById(mid).value);
        updateReview();
      });
    }
  });

  // ============================================================================
  // Image Upload Management
  // ============================================================================

  // Tab switching
  document.querySelectorAll('.image-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const targetTab = this.dataset.tab;
      
      // Update active tab button
      document.querySelectorAll('.image-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // Update active tab content
      document.querySelectorAll('.image-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${targetTab}-tab`).classList.add('active');
    });
  });

  // Gallery image selection
  document.querySelectorAll('.gallery-image').forEach(img => {
    img.addEventListener('click', function() {
      // Remove previous selection
      document.querySelectorAll('.gallery-image').forEach(i => i.classList.remove('selected'));
      
      // Select this image
      this.classList.add('selected');
      
      // Update hidden field
      const imagePath = this.dataset.image;
      document.getElementById('propertyImage').value = imagePath;
      wizard.updateData('image', imagePath);
    });
  });

  // File upload
  const fileInput = document.getElementById('image-file');
  const uploadPreview = document.getElementById('upload-preview');
  const uploadLoading = document.getElementById('upload-loading');
  const uploadArea = document.querySelector('.upload-area');
  
  // Function to process image file
  function processImageFile(file) {
    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
      alert('‚úñ Arquivo muito grande! M√°ximo 5MB.');
      return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
      alert('‚úñ Por favor, selecione uma imagem v√°lida.');
      return;
    }
    
    // Show loading
    if (uploadLoading) {
      uploadLoading.classList.add('show');
      uploadPreview.classList.remove('show');
    }
    
    // Read and display preview
    const reader = new FileReader();
    reader.onload = function(event) {
      const imageData = event.target.result;
      
      // Hide loading, show preview
      if (uploadLoading) uploadLoading.classList.remove('show');
      
      uploadPreview.innerHTML = `<img src="${imageData}" alt="Preview">`;
      uploadPreview.classList.add('show');
      
      // Update hidden field
      document.getElementById('propertyImage').value = imageData;
      wizard.updateData('image', imageData);
    };
    reader.onerror = function() {
      if (uploadLoading) uploadLoading.classList.remove('show');
      alert('‚úñ Erro ao processar imagem.');
    };
    reader.readAsDataURL(file);
  }
  
  fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    processImageFile(file);
  });

  // Drag and drop handlers
  if (uploadArea) {
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        processImageFile(files[0]);
      }
    });
  }

  // URL preview
  const urlInput = document.getElementById('image-url');
  const urlPreview = document.getElementById('url-preview');
  const btnPreviewUrl = document.getElementById('btn-preview-url');
  
  btnPreviewUrl.addEventListener('click', function() {
    const url = urlInput.value.trim();
    if (!url) {
      alert('‚úñ Digite uma URL v√°lida.');
      return;
    }
    
    // Create image element to test URL
    const img = new Image();
    img.onload = function() {
      urlPreview.innerHTML = `<img src="${url}" alt="Preview">`;
      urlPreview.classList.add('show');
      
      // Update hidden field
      document.getElementById('propertyImage').value = url;
      wizard.updateData('image', url);
    };
    img.onerror = function() {
      alert('‚úñ N√£o foi poss√≠vel carregar a imagem. Verifique a URL.');
    };
    img.src = url;
  });

  // ============================================================================
  // Room Categories
  // ============================================================================

  function applyTemplate(templateName) {
    wizard.applyTemplate(templateName);
    renderCategories();
  }

  function renderCategories() {
    const container = document.getElementById('category-list');
    if (!container) {
      console.warn('[Wizard] category-list container not found');
      return;
    }
    
    const categories = wizard.data.roomCategories;

    if (!categories || categories.length === 0) {
      let emptyMessage = 'Nenhuma categoria adicionada. Use um template ou adicione manualmente.';
      try {
        if (window.NEXEFII?.i18n) {
          emptyMessage = window.NEXEFII.i18n.t('wizard.rooms.emptyMessage') || emptyMessage;
        }
      } catch(e) {
        console.warn('[Wizard] Error getting translation:', e);
      }
      container.innerHTML = `<p style="color: #999; text-align: center; padding: 2rem;">${emptyMessage}</p>`;
      return;
    }

    // Get translations
  let removeLabel = 'Remover';
  let priceLabel = 'Pre√ßo:';
    let quantityLabel = 'Quantidade:';
    let roomsLabel = 'quartos';
    
    try {
      if (window.NEXEFII?.i18n) {
        removeLabel = window.NEXEFII.i18n.t('wizard.rooms.removeButton') || removeLabel;
        priceLabel = window.NEXEFII.i18n.t('wizard.rooms.priceLabel') || priceLabel;
        quantityLabel = window.NEXEFII.i18n.t('wizard.rooms.quantityLabel') || quantityLabel;
        roomsLabel = window.NEXEFII.i18n.t('wizard.rooms.roomsLabel') || roomsLabel;
      }
    } catch(e) {
      console.warn('[Wizard] Error getting category translations:', e);
    }

    // Get currency symbol based on current language (handle locales like 'pt-BR', 'en-US')
    const currentLang = (window.NEXEFII?.i18n?.getLanguage && window.NEXEFII.i18n.getLanguage()) || (navigator.language || 'pt');
    let currencySymbol = 'R$';
    try {
      if (/^pt/i.test(currentLang)) currencySymbol = 'R$';
      else if (/^en/i.test(currentLang)) currencySymbol = '$';
      else if (/^es/i.test(currentLang)) currencySymbol = '‚Ç¨';
    } catch (e) { /* keep default */ }

    container.innerHTML = categories.map((cat, index) => `
      <div class="category-card">
        <div class="category-card-header">
          <div class="category-name">${cat.name}</div>
          <button class="btn-remove" onclick="removeCategory(${index})">${removeLabel}</button>
        </div>
        <div class="form-grid">
          <div>
            <strong>${priceLabel}</strong> ${currencySymbol} ${cat.price}
          </div>
          <div>
            <strong>${quantityLabel}</strong> ${cat.count} ${roomsLabel}
          </div>
        </div>
      </div>
    `).join('');
  }

  function addCategory() {
    const name = prompt('Nome da categoria:');
    if (!name) return;

  const price = parseInt(prompt('Pre√ßo por noite (R$):')) || 0;
    const count = parseInt(prompt('Quantidade de quartos:')) || 0;

    wizard.addRoomCategory({ name, price, count, capacity: 2 });
    renderCategories();
  }

  function removeCategory(index) {
    wizard.removeRoomCategory(index);
    renderCategories();
  }

  // ============================================================================
  // Review
  // ============================================================================

  function updateReview() {
    const data = wizard.getData();

    // Update property image
    const reviewImage = document.getElementById('review-image');
    if (reviewImage && data.image) {
      reviewImage.src = data.image;
    }

    document.getElementById('review-name').textContent = data.name;
    document.getElementById('review-slug').textContent = data.slug;
    document.getElementById('review-type').textContent = data.type;
    document.getElementById('review-roomsCount').textContent = data.roomsCount;
    document.getElementById('review-currency').textContent = data.settings.currency;
    document.getElementById('review-checktimes').textContent = 
      `${data.settings.checkInTime} / ${data.settings.checkOutTime}`;

    // Render categories
    const categoriesHTML = data.roomCategories.map(cat => `
      <div class="review-item">
        <span class="review-label">${cat.name}</span>
        <span class="review-value">${cat.count} quartos √ó R$ ${cat.price}</span>
      </div>
    `).join('');
    document.getElementById('review-categories').innerHTML = categoriesHTML;

    // Render selected modules
    const modulesContainer = document.getElementById('review-modules');
    if (modulesContainer) {
      if (data.modules && data.modules.length > 0) {
        modulesContainer.innerHTML = data.modules.map(m => `<span class="review-value">${m}</span>`).join(', ');
      } else {
  modulesContainer.innerHTML = '<span style="color:#999;">Nenhum m√≥dulo selecionado</span>';
      }
    }
  }

  // ============================================================================
  // Create Property
  // ============================================================================

  function showProgressModal() {
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'progress-modal';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    `;

    // Create modal content
    const modal = document.createElement('div');
    modal.style.cssText = `
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      text-align: center;
      color: white;
    `;

      modal.innerHTML = `
      <div style="font-size: 48px; margin-bottom: 20px;">üè®</div>
      <h2 style="margin: 0 0 10px; font-size: 24px; font-weight: 600;">Criando sua propriedade</h2>
      <p id="progress-status" style="margin: 0 0 30px; font-size: 16px; opacity: 0.9;">Preparando...</p>
      
      <div style="background: rgba(255, 255, 255, 0.2); border-radius: 10px; height: 12px; overflow: hidden; margin-bottom: 20px;">
        <div id="progress-bar" style="background: white; height: 100%; width: 0%; transition: width 0.5s ease-out; border-radius: 10px;"></div>
      </div>
      
      <div id="progress-steps" style="font-size: 14px; opacity: 0.8; line-height: 1.6;">
        <div id="step-1">‚Ä¢ Criando estrutura...</div>
        <div id="step-2">‚Ä¢ Gerando quartos...</div>
        <div id="step-3">‚Ä¢ Criando h√≥spedes...</div>
        <div id="step-4">‚Ä¢ Gerando reservas...</div>
        <div id="step-5">‚Ä¢ Salvando dados...</div>
      </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    return {
      updateProgress: (percent, status) => {
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-status').textContent = status;
      },
      completeStep: (stepNum) => {
        const stepEl = document.getElementById(`step-${stepNum}`);
        if (stepEl) {
          stepEl.innerHTML = stepEl.innerHTML.replace('‚Ä¢', '‚úì');
          stepEl.style.opacity = '1';
          stepEl.style.fontWeight = '600';
        }
      },
      showSuccess: (propertyName) => {
        modal.innerHTML = `
          <div style="font-size: 64px; margin-bottom: 20px; animation: bounce 0.6s;">üéâ</div>
          <h2 style="margin: 0 0 10px; font-size: 28px; font-weight: 600;">Pronto!</h2>
          <p style="margin: 0 0 20px; font-size: 18px; opacity: 0.95;">
            "${propertyName}" foi criada com sucesso!
          </p>
          <p style="margin: 0; font-size: 16px; opacity: 0.8;">
            Redirecionando para o dashboard...
          </p>
          <style>
            @keyframes bounce {
              0%, 100% { transform: translateY(0); }
              50% { transform: translateY(-20px); }
            }
          </style>
        `;
      },
      close: () => {
        overlay.remove();
      }
    };
  }

  async function createProperty() {
    const btnCreate = document.getElementById('btn-create');
    btnCreate.disabled = true;
    btnCreate.textContent = 'Criando...';

    const progress = showProgressModal();

    try {
      // Step 1: Create structure (20%)
      progress.updateProgress(10, 'Criando estrutura da propriedade...');
      await new Promise(resolve => setTimeout(resolve, 300));
      progress.completeStep(1);
      progress.updateProgress(20, 'Estrutura criada!');
      
      // Step 2: Generate rooms (40%)
      progress.updateProgress(30, 'Gerando quartos...');
      await new Promise(resolve => setTimeout(resolve, 400));
      progress.completeStep(2);
      progress.updateProgress(40, 'Quartos criados!');
      
      // Step 3: Create guests (60%)
  progress.updateProgress(50, 'Criando h√≥spedes de exemplo...');
      await new Promise(resolve => setTimeout(resolve, 300));
  progress.completeStep(3);
  progress.updateProgress(60, 'H√≥spedes criados!');
      
      // Step 4: Generate reservations (80%)
      progress.updateProgress(70, 'Gerando reservas...');
      await new Promise(resolve => setTimeout(resolve, 400));
      progress.completeStep(4);
      progress.updateProgress(80, 'Reservas criadas!');
      
      // Step 5: Save everything (100%)
      progress.updateProgress(90, 'Salvando dados...');
      const property = await wizard.createProperty();
      property.modules = wizard.data.modules || [];
      progress.completeStep(5);
  progress.updateProgress(100, 'Conclu√≠do!');
      
      // Show success message
      await new Promise(resolve => setTimeout(resolve, 300));
      progress.showSuccess(property.name);
      
      // Wait a bit then redirect
      await new Promise(resolve => setTimeout(resolve, 2000));
      progress.close();

      // Persist created property to NexefiiProps (compat shim) and to user session
      try {
        const propRecord = Object.assign({}, property, { key: property.key || property.slug });
        if (window.NexefiiProps && typeof window.NexefiiProps.upsertProperty === 'function') {
          window.NexefiiProps.upsertProperty(propRecord);
        } else {
          // Fallback: write directly to localStorage under nexefii_properties
          try {
            const m = JSON.parse(localStorage.getItem('nexefii_properties') || '{}');
            m[propRecord.key] = propRecord;
            localStorage.setItem('nexefii_properties', JSON.stringify(m));
          } catch (e) { /* ignore */ }
        }

        // Also add to current user properties and persist session for Nexefii compatibility
        try {
          const sessionKey = 'nexefii_session';
          const altSessionKey = 'nexefii_session';
          let session = null;
          try { session = JSON.parse(localStorage.getItem(sessionKey) || 'null'); } catch(e) { session = null; }
          if (!session) {
            try { session = JSON.parse(localStorage.getItem(altSessionKey) || 'null'); } catch(e) { session = null; }
          }
          if (!session) session = window.NEXEFII.currentUser || { properties: [] };
          session.properties = session.properties || [];
          // avoid duplicates by key
          if (!session.properties.some(p => p.key === propRecord.key || p.slug === propRecord.slug)) {
            session.properties.push({ id: propRecord.id || propRecord.key, key: propRecord.key, slug: propRecord.slug, name: propRecord.name });
          }
          localStorage.setItem(sessionKey, JSON.stringify(session));
          localStorage.setItem(altSessionKey, JSON.stringify(session));
          window.NEXEFII.currentUser = session;
        } catch (e) { console.warn('[Wizard] session persist failed', e); }
      } catch (e) { console.warn('[Wizard] upsert property failed', e); }

      // Redirect to property dashboard
      window.NEXEFII.router.navigate(`/property/${property.slug}/dashboard`);
      
    } catch (error) {
      console.error('[Wizard] Error creating property:', error);
      progress.close();
  alert(`‚úñ Erro ao criar propriedade:\n\n${error.message}`);
      btnCreate.disabled = false;
      try {
        const text = window.NEXEFII?.i18n ? window.NEXEFII.i18n.t('wizard.buttons.create') : '‚ú® Criar Propriedade';
        btnCreate.textContent = text;
      } catch(_) { btnCreate.textContent = '‚ú® Criar Propriedade'; }
    }
  }
  // Registrar globalmente para acesso externo (shell.html)
  window.createProperty = createProperty;

  // ============================================================================
  // Initialize
  // ============================================================================

  async function initWizardPage() {
    console.log('[Wizard] Initializing wizard page');
    // Ensure every translatable element has a stable default text attribute so
    // we can restore it if translations are missing or incorrect. This helps
    // avoid showing raw i18n keys (e.g., 'wizard.step6.basicInfo') in the UI.
    try {
      const scopeAll = document.querySelector('.wizard-page');
      if (scopeAll) {
        scopeAll.querySelectorAll('[data-i18n]').forEach(el => {
          try {
            if (!el.hasAttribute('data-i18n-default')) {
              el.setAttribute('data-i18n-default', (el.textContent || '').trim());
            }
          } catch (_) {}
        });
      }
    } catch (e) { /* non-critical */ }

    // Wait for the global i18n helper to be available (race with shell/router load).
    // If it's already present this resolves immediately. Timeout after 1500ms and continue.
    function waitForI18n(timeoutMs = 1500) {
      return new Promise((resolve) => {
        if (window.NEXEFII && window.NEXEFII.i18n) return resolve(window.NEXEFII.i18n);
        const start = Date.now();
        const iv = setInterval(() => {
          if (window.NEXEFII && window.NEXEFII.i18n) {
            clearInterval(iv);
            return resolve(window.NEXEFII.i18n);
          }
          if (Date.now() - start > timeoutMs) {
            clearInterval(iv);
            return resolve(null);
          }
        }, 50);
      });
    }
    
    // Prepare timezone rendering function (used both on init and when language changes)
    function renderTimezoneSelect() {
      const tzSelect = document.getElementById('timezone');
      if (!tzSelect) return;
      // Backup: lista de grupos e cidades/fusos (hardcoded, pode ser movido para JSON futuramente)
      const tzData = [
        {
          key: 'americas',
          options: [
            { value: 'America/New_York', label: 'Nova York (UTC-5)' },
            { value: 'America/Los_Angeles', label: 'Los Angeles (UTC-8)' },
            { value: 'America/Chicago', label: 'Chicago (UTC-6)' },
            { value: 'America/Denver', label: 'Denver (UTC-7)' },
            { value: 'America/Toronto', label: 'Toronto (UTC-5)' },
            { value: 'America/Sao_Paulo', label: 'S√£o Paulo (UTC-3)' },
            { value: 'America/Manaus', label: 'Manaus (UTC-4)' },
            { value: 'America/Rio_Branco', label: 'Rio Branco (UTC-5)' },
            { value: 'America/Fortaleza', label: 'Fortaleza (UTC-3)' },
            { value: 'America/Buenos_Aires', label: 'Buenos Aires (UTC-3)' },
            { value: 'America/Santiago', label: 'Santiago (UTC-3)' },
            { value: 'America/Lima', label: 'Lima (UTC-5)' },
            { value: 'America/Bogota', label: 'Bogot√° (UTC-5)' },
            { value: 'America/Mexico_City', label: 'Cidade do M√©xico (UTC-6)' },
            { value: 'America/Caracas', label: 'Caracas (UTC-4)' }
          ]
        },
        {
          key: 'europe',
          options: [
            { value: 'Europe/London', label: 'Londres (UTC+0)' },
            { value: 'Europe/Paris', label: 'Paris (UTC+1)' },
            { value: 'Europe/Berlin', label: 'Berlim (UTC+1)' },
            { value: 'Europe/Madrid', label: 'Madri (UTC+1)' },
            { value: 'Europe/Rome', label: 'Roma (UTC+1)' },
            { value: 'Europe/Amsterdam', label: 'Amsterd√£ (UTC+1)' },
            { value: 'Europe/Brussels', label: 'Bruxelas (UTC+1)' },
            { value: 'Europe/Zurich', label: 'Zurique (UTC+1)' },
            { value: 'Europe/Lisbon', label: 'Lisboa (UTC+0)' },
            { value: 'Europe/Moscow', label: 'Moscou (UTC+3)' }
          ]
        },
        {
          key: 'asiaPacific',
          options: [
            { value: 'Asia/Tokyo', label: 'T√≥quio (UTC+9)' },
            { value: 'Asia/Shanghai', label: 'Xangai (UTC+8)' },
            { value: 'Asia/Hong_Kong', label: 'Hong Kong (UTC+8)' },
            { value: 'Asia/Singapore', label: 'Singapura (UTC+8)' },
            { value: 'Asia/Seoul', label: 'Seul (UTC+9)' },
            { value: 'Asia/Dubai', label: 'Dubai (UTC+4)' },
            { value: 'Asia/Bangkok', label: 'Bangkok (UTC+7)' },
            { value: 'Asia/Kolkata', label: 'Mumbai (UTC+5:30)' },
            { value: 'Australia/Sydney', label: 'Sydney (UTC+10)' },
            { value: 'Australia/Melbourne', label: 'Melbourne (UTC+10)' },
            { value: 'Pacific/Auckland', label: 'Auckland (UTC+12)' }
          ]
        },
        {
          key: 'africaMiddleEast',
          options: [
            { value: 'Africa/Cairo', label: 'Cairo (UTC+2)' },
            { value: 'Africa/Johannesburg', label: 'Joanesburgo (UTC+2)' },
            { value: 'Africa/Lagos', label: 'Lagos (UTC+1)' },
            { value: 'Asia/Jerusalem', label: 'Jerusal√©m (UTC+2)' },
            { value: 'Asia/Istanbul', label: 'Istambul (UTC+3)' }
          ]
        }
      ];
      // Limpar select
      tzSelect.innerHTML = '';
  // Renderizar grupos e op√ß√µes
      tzData.forEach(group => {
        const label = window.NEXEFII?.i18n?.t('wizard.config.timezoneGroups.' + group.key) || group.key;
        const optgroup = document.createElement('optgroup');
        optgroup.label = label;
        group.options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.value;
          // Busca nome traduzido da cidade/fuso
          // Prefer translated city name, fallback to hardcoded label. Then
          // normalize UTC signs ‚Äî in some cases a missing '+' was observed
          // (e.g. "UTC 7/-5"), so ensure offsets have explicit signs.
          let label = window.NEXEFII?.i18n?.t('wizard.config.timezoneCities.' + opt.value) || opt.label;
          try {
            // Replace 'UTC ' followed by digits with 'UTC+' (missing plus)
            label = label.replace(/UTC\s+(?=\d)/g, 'UTC+');
            // Ensure each UTC offset has an explicit sign before the number
            label = label.replace(/UTC([+-]?)(\d+)/g, (m, s, n) => `UTC${s || '+'}${n}`);
          } catch (e) { /* ignore normalization errors */ }
          option.textContent = label;
          optgroup.appendChild(option);
        });
        tzSelect.appendChild(optgroup);
      });
    }

    // Try to wait briefly for i18n to be ready so the page is translated on first render.
    const i18n = await waitForI18n();
    if (i18n) {
      try {
        // Capture default/fallback text for elements with data-i18n so we can
        // restore them if the translation is missing (some bundles return the
        // key itself when a translation is absent).
        const scope = document.querySelector('.wizard-page');
        const defaults = new Map();
        if (scope) {
          scope.querySelectorAll('[data-i18n]').forEach(el => {
            try {
              const key = el.getAttribute('data-i18n');
              const attrDefault = el.getAttribute('data-i18n-default');
              const textDefault = (el.textContent || '').trim();
              defaults.set(key, attrDefault || textDefault);
            } catch(_) {}
          });
        }

        // Apply translations to the wizard immediately (best-effort)
        i18n.applyToDOM(scope);

        // Restore fallback texts for keys that were not translated (t() returned the key)
        if (scope) {
          scope.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            const txt = (el.textContent || '').trim();
            if (txt === key && defaults.has(key)) {
              el.textContent = defaults.get(key);
            }
          });
        }
      } catch(e) { console.warn('[Wizard] i18n apply error at init', e); }

      // Subscribe to language changes so we re-render the select and re-apply translations
      try {
        i18n.onChange((lang) => {
          console.log('[Wizard] Language changed to:', lang);
          // Step 4: Rooms
          const step4 = document.getElementById('step-3');
          if (step4 && step4.classList.contains('active')) {
            renderCategories();
          }
          // Re-render timezone select using current translations
          renderTimezoneSelect();
          // Re-apply translations to DOM, preserving defaults for missing keys
          try {
            const scope = document.querySelector('.wizard-page');
            const defaults = new Map();
            if (scope) {
              scope.querySelectorAll('[data-i18n]').forEach(el => {
                try {
                  const key = el.getAttribute('data-i18n');
                  const attrDefault = el.getAttribute('data-i18n-default');
                  const textDefault = (el.textContent || '').trim();
                  defaults.set(key, attrDefault || textDefault);
                } catch(_) {}
              });
            }
            i18n.applyToDOM(scope);
            if (scope) {
              scope.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const txt = (el.textContent || '').trim();
                if (txt === key && defaults.has(key)) {
                  el.textContent = defaults.get(key);
                }
              });
            }
          } catch(e) { /* ignore */ }
        });
      } catch(e) { console.warn('[Wizard] failed to subscribe to i18n changes', e); }
    } else {
      console.warn('[Wizard] I18n not available (timed out)');
    }

    // Ensure timezone select is populated on initial load as well
    try { renderTimezoneSelect(); } catch(e) { console.warn('[Wizard] renderTimezoneSelect failed', e); }
    
    updateUI();

    // After UI update, sanitize any elements that still contain raw i18n keys
    // (defensive) ‚Äî replace with the data-i18n-default attribute or a
    // humanized version of the key.
    function humanizeKey(key) {
      if (!key) return '';
      // prefer last token after dot
      const last = key.split('.').pop();
      // split camelCase and underscores/dashes
      const spaced = last.replace(/([a-z])([A-Z])/g, '$1 $2')
                        .replace(/[_-]+/g, ' ')
                        .replace(/\b([a-z])/g, s => s.toUpperCase());
      return spaced;
    }

    function sanitizeTranslatedKeys(scope) {
      try {
        const root = scope || document.querySelector('.wizard-page');
        if (!root) return;
        root.querySelectorAll('[data-i18n]').forEach(el => {
          try {
            const txt = (el.textContent || '').trim();
            const key = el.getAttribute('data-i18n');
            const def = el.getAttribute('data-i18n-default');
            // If the element text looks like an untranslated key (contains a dot
            // or starts with the key), replace it with the default or a human
            // friendly label.
            if (!txt) return;
            if (txt === key || /\b[a-z]+\.[a-z0-9_.-]+/i.test(txt) || txt.includes('.') ) {
              if (def && def.length) {
                el.textContent = def;
              } else {
                el.textContent = humanizeKey(key);
              }
            }
          } catch (_) {}
        });
      } catch (_) {}
    }

    // run once now
    sanitizeTranslatedKeys();
  }

  // Initialize wizard page when loaded
  initWizardPage();
</script>
 
</body>
</html>

