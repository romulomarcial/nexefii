<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="NEXEFII - Next-generation multi-tenant hospitality platform login">
  <meta name="theme-color" content="#E42121">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="assets/Nexefii_logo_3d-official.png">
  <link rel="apple-touch-icon" href="assets/Nexefii_logo_3d-official.png">
  <title>NEXEFII · Login</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --line:#e7eaf0; --text:#0f172a; --muted:#64748b;
      --primary:#2f6bff; --primary-contrast:#ffffff; --shadow:0 10px 30px rgba(15,23,42,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{width:100%;max-width:520px;background:var(--card);border:1px solid var(--line);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:28px 28px 24px}
  .brand{display:flex;align-items:center;gap:10px;margin-bottom:18px}
  .brand{justify-content:center;}
  .brand img{height:72px;max-width:220px;display:block;margin:0 auto;}
  @media(min-width:1200px){ .brand img{height:88px;max-width:260px;} }
    .title{font-weight:700;font-size:15px;letter-spacing:.2px}
    label{display:block;font-size:12px;color:var(--muted);margin:12px 0 6px}
    select,input{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;
      font-size:14px;outline:none;background:#fff}
    select:focus,input:focus{border-color:#cbd5e1;box-shadow:0 0 0 4px rgba(47,107,255,.08)}
    .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;border-radius:12px;
      padding:12px 16px;border:1px solid var(--line);cursor:pointer;font-weight:600}
    .primary{background:var(--primary);color:var(--primary-contrast);border-color:var(--primary)}
    .full{width:100%}
    .hint{margin-top:10px;color:var(--muted);font-size:12px;text-align:center}
    .secure{margin-top:10px;color:var(--muted);font-size:12px;display:flex;align-items:center;justify-content:center;gap:8px}
    .secure svg{width:16px;height:16px;flex:0 0 16px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
  <img src="assets/Nexefii_logo_3d-official.png" alt="NEXEFII" style="height:72px;max-width:220px;display:block;margin:0 auto;">
      </div>

      <label id="labLang">Idioma</label>
      <select id="lang">
        <option value="pt">Português (Brasil)</option>
        <option value="en">English</option>
        <option value="es">Español</option>
      </select>

      <label id="labUser">Usuário</label>
      <input id="user" class="input" placeholder="usuario@empresa.com" autocomplete="username">

      <label id="labPwd">Senha</label>
      <input id="pwd" type="password" class="input" placeholder="********" autocomplete="current-password">

      <button id="btnEnter" class="btn primary full" style="margin-top:14px" onclick="doLogin()">Entrar</button>
      <div class="hint" id="hintText"></div>
      <div class="secure" id="secureInfo">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M6 10V8a6 6 0 1 1 12 0v2" stroke="#64748b" stroke-width="1.5" stroke-linecap="round"/>
          <rect x="4" y="10" width="16" height="10" rx="2" stroke="#64748b" stroke-width="1.5"/>
          <circle cx="12" cy="15" r="1.5" fill="#64748b"/>
        </svg>
        <span id="secureText">Conexão segura. Seus dados são criptografados.</span>
      </div>
      
      <div style="text-align:center;margin-top:16px;font-size:13px;color:var(--muted)">
        <span id="noAccountText">Não tem uma conta?</span>
        <a href="register.html" style="color:var(--primary);font-weight:600;text-decoration:none" id="registerLink">Solicitar acesso</a>
      </div>
      
      <div id="loginError" style="display:none;margin-top:12px;padding:10px;background:#fee;border:1px solid #fcc;border-radius:8px;color:#c00;font-size:13px;text-align:center"></div>
    </div>
  </div>

  <script src="nexefii-auth.js"></script>
  <script src="js/user-model.js"></script>
  <!-- i18n isolado do LOGIN -->
  <script>
    let I18N_LOGIN = null;
    const DEFAULT_LOGIN_I18N = {
      pt:{ lang:'Idioma', user:'Usuário', pwd:'Senha', enter:'Entrar', phUser:'usuario@empresa.com', phPwd:'********', hint:'Seu idioma fica salvo para as próximas telas.', empty:'Informe usuário e senha.', noAccount:'Não tem uma conta?', requestAccess:'Solicitar acesso', invalidCredentials:'Usuário ou senha inválidos', userPending:'Sua solicitação está em análise', userDenied:'Acesso negado. Entre em contato com o administrador.', genericError:'Erro ao fazer login. Tente novamente.', secureMsg:'Conexão segura. Seus dados são criptografados.' },
      en:{ lang:'Language', user:'User', pwd:'Password', enter:'Enter', phUser:'user@company.com', phPwd:'********', hint:'Your language is saved for the next screens.', empty:'Type user and password.', noAccount:"Don't have an account?", requestAccess:'Request access', invalidCredentials:'Invalid username or password', userPending:'Your request is under review', userDenied:'Access denied. Contact the administrator.', genericError:'Login error. Please try again.', secureMsg:'Secure connection. Your data is encrypted.' },
      es:{ lang:'Idioma', user:'Usuario', pwd:'Contraseña', enter:'Ingresar', phUser:'usuario@empresa.com', phPwd:'********', hint:'Su idioma se guarda para las próximas pantallas.', empty:'Informe usuario y contraseña.', noAccount:'¿No tienes una cuenta?', requestAccess:'Solicitar acceso', invalidCredentials:'Usuario o contraseña inválidos', userPending:'Su solicitud está en revisión', userDenied:'Acceso denegado. Contacte al administrador.', genericError:'Error al iniciar sesión. Inténtelo de nuevo.', secureMsg:'Conexión segura. Sus datos están cifrados.' }
    };
async function loadLoginI18N(){
  try{
    const res = await fetch('i18n/i18n.json',{cache:'no-store'});
    if(!res.ok) throw new Error('http');
    const data = await res.json();
    const merge = (base, extra) => ({...base, ...(extra||{})});
    I18N_LOGIN = {
      pt: merge(DEFAULT_LOGIN_I18N.pt, data?.pt?.login),
      en: merge(DEFAULT_LOGIN_I18N.en, data?.en?.login),
      es: merge(DEFAULT_LOGIN_I18N.es, data?.es?.login)
    };
  }catch(e){
    // fallback embedded map (file:// or error)
    I18N_LOGIN = DEFAULT_LOGIN_I18N;
  }
}

    function applyLoginLang(){
  if(!I18N_LOGIN) return;
      const sel = document.getElementById('lang');
      const L = I18N_LOGIN[sel.value] || I18N_LOGIN.pt;

      // rótulos e botão
      document.getElementById('labLang').innerText = L.lang;
      document.getElementById('labUser').innerText = L.user;
      document.getElementById('labPwd').innerText  = L.pwd;
      document.getElementById('btnEnter').innerText = L.enter;

      // placeholders e dica
      document.getElementById('user').placeholder = L.phUser;
      document.getElementById('pwd').placeholder  = L.phPwd;
      document.getElementById('hintText').innerText = L.hint;
  document.getElementById('secureText').innerText = L.secureMsg || DEFAULT_LOGIN_I18N.pt.secureMsg;
      
      // link de registro
  document.getElementById('noAccountText').innerText = L.noAccount || DEFAULT_LOGIN_I18N.pt.noAccount;
  document.getElementById('registerLink').innerText = L.requestAccess || DEFAULT_LOGIN_I18N.pt.requestAccess;

      // persiste para o app
      localStorage.setItem('nexefii_lang', sel.value);
    }

    function showLoginError(message) {
      const errorDiv = document.getElementById('loginError');
      errorDiv.innerText = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    async function doLogin(){
      const lang = document.getElementById('lang').value;
      const L = I18N_LOGIN[lang] || I18N_LOGIN.pt;
      const user = (document.getElementById('user').value||'').trim();
      const pwd  = (document.getElementById('pwd').value||'').trim();
      
      if(!user || !pwd){
        showLoginError(L.empty);
        return;
      }

      try {
        // Authenticate using nexefii-auth.js
        const session = await NexefiiAuth.login(user, pwd);
        
        // Store language
        localStorage.setItem('nexefii_lang', lang);
        // Persist and synchronize user object expected by SessionContext and UserModel
        try {
          // sync with UserModel when available to centralize users
          var finalUser = null;
          if (window.UserModel && typeof window.UserModel.syncSessionUser === 'function') {
            finalUser = window.UserModel.syncSessionUser(session);
          } else {
            finalUser = Object.assign({}, session, { role: session.role || session.role, properties: session.properties || session.properties || [] });
            localStorage.setItem('nexefii_user', JSON.stringify(finalUser));
          }

          // Maintain legacy currentUser key used by master-control.js for compatibility
          try {
            if (finalUser && finalUser.role && String(finalUser.role).toUpperCase() === 'MASTER') {
              localStorage.setItem('currentUser', JSON.stringify({ id: finalUser.id || null, role: 'master', email: finalUser.email || '' }));
            } else {
              // remove legacy currentUser if present for non-master
              // keep it only when needed
            }
          } catch (e) { /* noop */ }
        } catch (e) { /* noop */ }

        // Redirect according to role: MASTER -> master-control.html, else -> pages/property-dashboard.html
        try {
          // prefer SessionContext if available
          const role = (window.SessionContext && typeof window.SessionContext.getUserRole === 'function') ? window.SessionContext.getUserRole() : (session.role || 'MASTER');
          if (role === 'MASTER') {
            window.location.href = '/master-control.html';
          } else {
            window.location.href = '/pages/property-dashboard.html';
          }
        } catch (e) {
          // fallback to shell if something unexpected
          window.location.href = '/shell.html';
        }
      } catch (error) {
        // If remote auth fails, attempt local authentication using UserModel
        try {
          console.log('[Login] Remote auth failed, attempting local auth for', user);
          if (window.UserModel && typeof window.UserModel.authenticateLocal === 'function') {
            const localUser = window.UserModel.authenticateLocal(user, pwd);
            if (localUser) {
              // treat localUser as session
              const session = localUser;
              localStorage.setItem('nexefii_lang', lang);
              try {
                var finalUser = null;
                if (window.UserModel && typeof window.UserModel.syncSessionUser === 'function') {
                  finalUser = window.UserModel.syncSessionUser(session);
                } else {
                  finalUser = Object.assign({}, session, { role: session.role || session.role, properties: session.properties || session.properties || [] });
                  localStorage.setItem('nexefii_user', JSON.stringify(finalUser));
                }
                try {
                  if (finalUser && finalUser.role && String(finalUser.role).toUpperCase() === 'MASTER') {
                    localStorage.setItem('currentUser', JSON.stringify({ id: finalUser.id || null, role: 'master', email: finalUser.email || '' }));
                  }
                } catch(e){}
              } catch(e){}
              // redirect
              const role = (window.SessionContext && typeof window.SessionContext.getUserRole === 'function') ? window.SessionContext.getUserRole() : (session.role || 'MASTER');
              if (role === 'MASTER') window.location.href = '/master-control.html'; else window.location.href = '/pages/property-dashboard.html';
              return;
            }
          }
        } catch (e) { console.warn('[Login] local auth fallback error', e); }
        showLoginError(error.message || L.genericError);
      }
    }

    // Inicializa
    window.addEventListener('DOMContentLoaded', async () => {
  await loadLoginI18N();
      const saved = localStorage.getItem('nexefii_lang') || 'pt';
      const sel = document.getElementById('lang');
      sel.value = saved;     // mantém idioma usado anteriormente
      applyLoginLang();      // aplica textos
      sel.addEventListener('change', applyLoginLang);
      
      // Add Enter key support
      document.getElementById('pwd').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') doLogin();
      });
    });
  </script>
  <script src="pwa-installer.js"></script>
</body>
</html>
