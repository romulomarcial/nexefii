<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEXEFII ¬∑ Hotel Management System</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#E42121">
  <meta name="description" content="NEXEFII - Advanced Hospitality Management System">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="assets/Nexefii_logo_3d-official.png">
  
  <!-- Core Styles -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --nexefii-red: #E42121;
      --nexefii-dark: #1A1A1A;
      --nexefii-gray: #333333;
      --nexefii-light-gray: #F5F5F5;
      --nexefii-border: #E0E0E0;
      --nexefii-white: #FFFFFF;
      --nexefii-success: #28A745;
      --nexefii-warning: #FFC107;
      --nexefii-error: #DC3545;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--nexefii-light-gray);
      color: var(--nexefii-dark);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* Header */
    .shell-header {
      background: var(--nexefii-white);
      border-bottom: 3px solid var(--nexefii-red);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
    }

    @media (max-width: 768px) {
      .header-content {
        padding: 0.75rem 1rem;
        gap: 1rem;
      }
    }

    @media (max-width: 480px) {
      .header-content {
        padding: 0.5rem;
        flex-wrap: wrap;
      }
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    @media (max-width: 768px) {
      .header-left {
        gap: 1rem;
      }
    }

    @media (max-width: 480px) {
      .header-left {
        gap: 0.5rem;
      }
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--nexefii-dark);
    }

    .logo img {
      height: 64px; /* increased for better visibility per UX */
      width: auto;
      display: block;
    }

    /* Responsive logo sizes */
    @media (max-width: 768px) {
      .logo img { height: 52px; }
    }
    @media (max-width: 480px) {
      .logo img { height: 40px; }
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    @media (max-width: 768px) {
      .logo-text {
        font-size: 1.25rem;
      }
    }

    @media (max-width: 480px) {
      .logo-text {
        font-size: 1.1rem;
        display: none; /* Hide text on very small screens, keep only logo */
      }
    }

    /* Breadcrumbs */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #666;
    }

    @media (max-width: 768px) {
      .breadcrumb {
        font-size: 0.75rem;
      }
    }

    @media (max-width: 480px) {
      .breadcrumb {
        display: none; /* Hide breadcrumbs on mobile */
      }
    }

    .breadcrumb-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .breadcrumb-link {
      color: #666;
      text-decoration: none;
      transition: color 0.2s;
    }

    .breadcrumb-link:hover {
      color: var(--nexefii-red);
    }

    .breadcrumb-separator {
      color: #999;
    }

    .breadcrumb-current {
      color: var(--nexefii-dark);
      font-weight: 500;
    }

    /* Property Badge */
    .property-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, var(--nexefii-red), #C41A1A);
      color: white;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(228, 33, 33, 0.3);
    }

    .property-icon {
      font-size: 1rem;
    }

    /* User Menu */
    .header-right {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .lang-selector {
      position: relative;
    }

    .lang-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--nexefii-border);
      background: var(--nexefii-white);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .lang-btn:hover {
      border-color: var(--nexefii-red);
      background: var(--nexefii-light-gray);
    }

    .lang-flag {
      font-size: 1.2rem;
      line-height: 1;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .user-menu:hover {
      background: var(--nexefii-light-gray);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--nexefii-red);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .user-name {
      font-size: 0.875rem;
      font-weight: 500;
    }

    @media (max-width: 480px) {
      .user-name {
        display: none; /* Hide user name on mobile, keep only avatar */
      }
    }

    /* Main Content */
    .shell-main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      min-height: calc(100vh - 200px);
    }

    @media (max-width: 768px) {
      .shell-main {
        padding: 1.5rem 1rem;
      }
    }

    @media (max-width: 480px) {
      .shell-main {
        padding: 1rem 0.5rem;
      }
    }

    #app {
      background: var(--nexefii-white);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      min-height: 400px;
    }

    @media (max-width: 768px) {
      #app {
        padding: 1.5rem;
        border-radius: 8px;
      }
    }

    @media (max-width: 480px) {
      #app {
        padding: 1rem;
        border-radius: 4px;
        box-shadow: none;
      }
    }

    /* Loading State */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      gap: 1.5rem;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--nexefii-light-gray);
      border-top-color: var(--nexefii-red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #666;
      font-size: 0.875rem;
    }

    /* Error State */
    .error-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      gap: 1rem;
      text-align: center;
    }

    .error-icon {
      font-size: 4rem;
      color: var(--nexefii-error);
    }

    .error-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--nexefii-dark);
    }

    .error-message {
      color: #666;
      max-width: 500px;
    }

    .error-button {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background: var(--nexefii-red);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .error-button:hover {
      background: #C41A1A;
    }

    /* Footer */
    .shell-footer {
      background: var(--nexefii-white);
      border-top: 1px solid var(--nexefii-border);
      padding: 2rem;
      margin-top: 4rem;
    }

    .footer-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #666;
      font-size: 0.875rem;
    }

    .footer-links {
      display: flex;
      gap: 2rem;
    }

    .footer-link {
      color: #666;
      text-decoration: none;
      transition: color 0.2s;
    }

    .footer-link:hover {
      color: var(--nexefii-red);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }

      .header-left {
        width: 100%;
        justify-content: space-between;
      }

      .breadcrumb {
        display: none;
      }

      .shell-main {
        padding: 1rem;
      }

      #app {
        padding: 1rem;
      }

      .footer-content {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .footer-links {
        flex-direction: column;
        gap: 0.5rem;
      }
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="shell-header">
    <div class="header-content">
      <div class="header-left">
        <a href="/" class="logo" data-router-link aria-label="Nexefii">
          <img src="/assets/Nexefii_logo_3d-official.png" alt="NEXEFII Logo">
          <!-- logo text removed to use only the visual mark for a cleaner header -->
        </a>
        
        <nav class="breadcrumb" id="breadcrumb">
          <!-- Breadcrumbs injected dynamically -->
        </nav>
      </div>

      <div class="header-right">
        <div class="property-badge hidden" id="property-badge">
          <span class="property-icon">üè®</span>
          <span id="property-name">Property Name</span>
        </div>

        <!-- Language Selector -->
        <div class="lang-selector">
          <button class="lang-btn" id="lang-btn" onclick="toggleLanguage()">
            <span class="lang-flag" id="lang-flag">üáßüá∑</span>
            <span id="lang-code">PT</span>
          </button>
        </div>

        <div class="user-menu" onclick="toggleUserMenu()">
          <div class="user-avatar" id="user-avatar">U</div>
          <span class="user-name" id="user-name">User</span>
        </div>
        <!-- Dev Tools: SW Cache Clear -->
        <button id="btn-clear-sw" style="display:none;padding:0.5rem 0.9rem;border:1px solid var(--nexefii-border);background:var(--nexefii-white);border-radius:8px;font-size:0.75rem;font-weight:600;cursor:pointer;color:var(--nexefii-dark);" title="Limpar cache do Service Worker">
          SW Clear
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <main class="shell-main">
    <div id="app">
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <p class="loading-text">Carregando...</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="shell-footer">
    <div class="footer-content">
      <div data-i18n="footer.copy">&copy; 2025 NEXEFII. Todos os direitos reservados.</div>
        <div class="footer-links">
        <a href="/help" class="footer-link" data-router-link data-i18n="footer.help">Ajuda</a>
        <a href="/privacy" class="footer-link" data-router-link data-i18n="footer.privacy">Privacidade</a>
        <a href="/terms" class="footer-link" data-router-link data-i18n="footer.terms">Termos</a>
      </div>
    </div>
  </footer>

  <!-- Core Scripts -->
  <script src="/nexefii-auth.js"></script>
  <script src="/properties.js"></script>
  <script src="/core/database/PropertyDatabase.js"></script>
  <script src="/core/router/Router.js"></script>
  <script src="/core/wizard/WizardManager.js"></script>
  <script src="/core/i18n/I18nManager.js"></script>
  <script src="/pwa-installer.js"></script>

  <!-- Shell Application Script -->
  <script>
    // ============================================================================
    // NEXEFII Shell Application
    // ============================================================================

    // Global state (merge to avoid overwriting previously defined properties like i18n)
    window.NEXEFII = Object.assign(window.NEXEFII || {}, {
      router: null,
      currentProperty: null,
      currentDB: null,
      currentUser: null,
      pageModules: new Map() // Cache for page-specific modules
    });

    // ============================================================================
    // Initialization
    // ============================================================================

    async function initShell() {
      console.log('[Shell] Initializing NEXEFII Shell...');

      // Ensure hash mode is active
      if (!window.location.hash) {
        window.location.hash = '#/';
      }

      // Initialize i18n
      await initI18n();

      // Load user session
      await loadUserSession();

      // Initialize Router
      initRouter();

      // Start Router
      window.NEXEFII.router.start();

      console.log('[Shell] Shell initialized successfully');
    }

    // ============================================================================
    // Internationalization
    // ============================================================================

    async function initI18n() {
      console.log('[Shell] Initializing i18n...');
      // Ensure global container exists and i18n is attached
      window.NEXEFII = window.NEXEFII || {};
      if (!window.NEXEFII.i18n && typeof I18nManager !== 'undefined') {
        window.NEXEFII.i18n = new I18nManager();
        console.log('[Shell] I18nManager instance created');
      }

      const i18n = window.NEXEFII.i18n;
      if (!i18n || typeof i18n.loadTranslations !== 'function') {
        console.error('[Shell] i18n not available; skipping i18n init');
        return; // Gracefully continue; UI will remain in default language
      }
  await i18n.loadTranslations();
  // Apply once on initial load
  try { i18n.applyToDOM(); } catch(e) { console.warn('[Shell] initial i18n apply error', e); }
      
      // Update language UI
      updateLanguageUI();
      
      // Subscribe to language changes
      i18n.onChange((lang) => {
        console.log('[Shell] Language changed:', lang);
        updateLanguageUI();
        // Re-apply translations to current page
        i18n.applyToDOM();
      });
      
      console.log('[Shell] i18n initialized');
    }

    function updateLanguageUI() {
      const lang = window.NEXEFII.i18n.getLanguage();
      const langFlags = { pt: 'üáßüá∑', en: 'üá∫üá∏', es: 'üá™üá∏' };
      const langCodes = { pt: 'PT', en: 'EN', es: 'ES' };
      
      document.getElementById('lang-flag').textContent = langFlags[lang] || 'üáßüá∑';
      document.getElementById('lang-code').textContent = langCodes[lang] || 'PT';
    }

    function toggleLanguage() {
      try {
        const i18n = window.NEXEFII?.i18n;
        if (!i18n) {
          console.error('[Shell] I18n not available for language toggle');
          return;
        }
        
        const currentLang = i18n.getLanguage();
        const languages = ['pt', 'en', 'es'];
        const currentIndex = languages.indexOf(currentLang);
        const nextLang = languages[(currentIndex + 1) % languages.length];
        
        console.log('[Shell] Toggling language from', currentLang, 'to', nextLang);
        i18n.setLanguage(nextLang);
      } catch (error) {
        console.error('[Shell] Error toggling language:', error);
      }
    }

    // ============================================================================
    // User Session Management
    // ============================================================================

    async function loadUserSession() {
      // Check for existing session
      const sessionData = localStorage.getItem('nexefii_session');
      
      if (sessionData) {
        try {
          window.NEXEFII.currentUser = JSON.parse(sessionData);
          updateUserUI();
          console.log('[Shell] User session loaded:', window.NEXEFII.currentUser.email);
        } catch (e) {
          console.error('[Shell] Failed to parse session data:', e);
          redirectToLogin();
        }
      } else {
        // No session - redirect to login
        redirectToLogin();
      }
    }

    function updateUserUI() {
      const user = window.NEXEFII.currentUser;
      if (!user) return;

      // Update user name
      const userNameEl = document.getElementById('user-name');
      if (userNameEl) {
        userNameEl.textContent = user.name || user.email;
      }

      // Update user avatar
      const userAvatarEl = document.getElementById('user-avatar');
      if (userAvatarEl) {
        const initial = (user.name || user.email).charAt(0).toUpperCase();
        userAvatarEl.textContent = initial;
      }
    }

    function redirectToLogin() {
      // Check if already on login page
      if (window.location.pathname === '/login.html' || window.location.pathname === '/login') {
        return;
      }
      window.location.href = '/login.html';
    }

    function toggleUserMenu() {
      // TODO: Implement user menu dropdown
      console.log('[Shell] User menu clicked');
    }

    // ============================================================================
    // Router Configuration
    // ============================================================================

    function initRouter() {
      const router = new Router({
        mode: 'hash',
        debug: true
      });

      // Property Resolver
      router.setPropertyResolver(async (slug) => {
        console.log(`[Shell] Resolving property: ${slug}`);
        
        // Get user's properties
        const properties = window.NEXEFII.currentUser?.properties || [];
        const property = properties.find(p => p.slug === slug);
        
        if (property) {
          console.log(`[Shell] Property resolved:`, property);
          return property;
        }
        
        console.warn(`[Shell] Property not found: ${slug}`);
        return null;
      });

      // Auth Guard
      router.setAuthGuard(async () => {
        const isAuthenticated = !!window.NEXEFII.currentUser;
        console.log(`[Shell] Auth guard: ${isAuthenticated ? 'PASS' : 'FAIL'}`);
        
        if (!isAuthenticated) {
          redirectToLogin();
        }
        
        return isAuthenticated;
      });

      // Property Access Guard
      router.setPropertyAccessGuard(async (property) => {
        const userProperties = window.NEXEFII.currentUser?.properties || [];
        const hasAccess = userProperties.some(p => p.id === property.id);
        
        console.log(`[Shell] Property access guard for ${property.name}: ${hasAccess ? 'PASS' : 'FAIL'}`);
        
        if (!hasAccess) {
          await loadPage('error', null, {
            title: 'Acesso Negado',
            message: `Voc√™ n√£o tem permiss√£o para acessar ${property.name}`
          });
        }
        
        return hasAccess;
      });

      // Global middleware - Update breadcrumbs
      router.use(async (context) => {
        updateBreadcrumbs(context);
        updatePropertyBadge(context.property);
      });

      // ============================================================================
      // Route Definitions
      // ============================================================================

      // Home page
      router.route('/', async (ctx) => {
        await loadPage('home');
      }, { name: 'home' });

      // Property Dashboard
      router.route('/property/:slug/dashboard', async (ctx) => {
        await loadPage('dashboard', ctx.property);
      }, { name: 'property-dashboard' });

      // Property Settings
      router.route('/property/:slug/settings', async (ctx) => {
        await loadPage('settings', ctx.property);
      }, { name: 'property-settings' });

      // Property Rooms
      router.route('/property/:slug/rooms', async (ctx) => {
        await loadPage('rooms', ctx.property);
      }, { name: 'property-rooms' });

      // Property Reservations
      router.route('/property/:slug/reservations', async (ctx) => {
        await loadPage('reservations', ctx.property);
      }, { name: 'property-reservations' });

      // Help page
      router.route('/help', async (ctx) => {
        await loadPage('help');
      }, { name: 'help' });

      // Wizard page
      router.route('/wizard', async (ctx) => {
        await loadPage('wizard');
      }, { name: 'wizard' });

      // 404 Handler
      router.notFound(async (path, reason) => {
        console.log(`[Shell] 404: ${path} (reason: ${reason || 'not_found'})`);
        await loadPage('error', null, {
          title: 'P√°gina N√£o Encontrada',
          message: `A p√°gina "${path}" n√£o existe.`
        });
      });

      window.NEXEFII.router = router;
    }

    // ============================================================================
    // Page Loading System
    // ============================================================================

    async function loadPage(pageName, property = null, errorData = null) {
      console.log(`[Shell] Loading page: ${pageName}`, property);

      const appContainer = document.getElementById('app');
      
      // Show loading state
      showLoading();

      try {
        // Set current property context
        if (property) {
          window.NEXEFII.currentProperty = property;
          window.NEXEFII.currentDB = new PropertyDatabase(property.key);
          console.log(`[Shell] Property context set:`, property.name);
        } else {
          window.NEXEFII.currentProperty = null;
          window.NEXEFII.currentDB = null;
        }

        // Load page content
        let content;
        
        if (pageName === 'error' && errorData) {
          content = renderErrorPage(errorData);
        } else {
          content = await fetchPageContent(pageName);
        }

  // Render content with fade-in
  appContainer.innerHTML = content;
  appContainer.classList.add('fade-in');

  // Execute any script tags contained in the loaded HTML
  await executeInlineAndExternalScripts(appContainer);

  // Initialize page-specific functionality (expects e.g. initHomePage/initWizardPage on window)
  await initializePage(pageName, property);

        console.log(`[Shell] Page loaded successfully: ${pageName}`);

      } catch (error) {
        console.error(`[Shell] Failed to load page ${pageName}:`, error);
        
        appContainer.innerHTML = renderErrorPage({
          title: 'Erro ao Carregar P√°gina',
          message: error.message || 'Ocorreu um erro ao carregar a p√°gina.'
        });
      }
    }

    function showLoading() {
      const appContainer = document.getElementById('app');
      appContainer.innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p class="loading-text">Carregando...</p>
        </div>
      `;
    }

    async function fetchPageContent(pageName) {
      // Prevent caching issues on dynamic pages during dev
      const cacheBust = Date.now();
      const response = await fetch(`/pages/${pageName}.html?cb=${cacheBust}`);
      if (!response.ok) {
        throw new Error(`Failed to load page: ${response.statusText}`);
      }
      return await response.text();
    }

    function renderErrorPage(data) {
      return `
        <div class="error-container">
          <div class="error-icon">‚ö†Ô∏è</div>
          <h2 class="error-title">${data.title}</h2>
          <p class="error-message">${data.message}</p>
          <button class="error-button" onclick="window.NEXEFII.router.navigate('/')">
            Voltar para In√≠cio
          </button>
        </div>
      `;
    }

    async function initializePage(pageName, property) {
      // Check if page has initialization function
      const initFunctionName = `init${capitalize(pageName)}Page`;
      
      if (typeof window[initFunctionName] === 'function') {
        console.log(`[Shell] Calling page init: ${initFunctionName}`);
        await window[initFunctionName](property);
      }
    }

    // ============================================================================
    // UI Updates
    // ============================================================================

    function updateBreadcrumbs(context) {
      const breadcrumbEl = document.getElementById('breadcrumb');
      if (!breadcrumbEl) return;

      const breadcrumbs = [];

      // Home (use i18n key so translations are applied dynamically)
      breadcrumbs.push({ labelKey: 'master.breadcrumb.home', label: 'In√≠cio', path: '/' });

      // Property
      if (context.property) {
        breadcrumbs.push({ 
          label: context.property.name, 
          path: `/property/${context.property.slug}/dashboard` 
        });
      }

      // Current page
      if (context.route?.meta?.title) {
        breadcrumbs.push({ label: context.route.meta.title, path: null });
      }

      // Render breadcrumbs
      breadcrumbEl.innerHTML = breadcrumbs.map((item, index) => {
        const isLast = index === breadcrumbs.length - 1;
        
        if (isLast || !item.path) {
          // If a translation key was provided, include data-i18n so I18nManager can replace it
          if (item.labelKey) {
            return `<span class="breadcrumb-current" data-i18n="${item.labelKey}">${item.label}</span>`;
          }
          return `<span class="breadcrumb-current">${item.label}</span>`;
        }
        
        return `
          <div class="breadcrumb-item">
            <a href="${item.path}" class="breadcrumb-link" data-router-link ${item.labelKey ? `data-i18n="${item.labelKey}"` : ''}>${item.label}</a>
            <span class="breadcrumb-separator">/</span>
          </div>
        `;
      }).join('');

      // Apply i18n to the breadcrumb element if i18n is available
      try {
        if (window.NEXEFII && window.NEXEFII.i18n && typeof window.NEXEFII.i18n.applyToDOM === 'function') {
          window.NEXEFII.i18n.applyToDOM(breadcrumbEl);
        }
      } catch (e) {
        console.warn('[Shell] Breadcrumb i18n apply error', e);
      }
    }

    function updatePropertyBadge(property) {
      const badgeEl = document.getElementById('property-badge');
      const nameEl = document.getElementById('property-name');
      
      if (!badgeEl || !nameEl) return;

      if (property) {
        badgeEl.classList.remove('hidden');
        nameEl.textContent = property.name;
      } else {
        badgeEl.classList.add('hidden');
      }
    }

    // ============================================================================
    // Utility Functions
    // ============================================================================

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Execute <script> tags that came with fetched HTML content
    async function executeInlineAndExternalScripts(container) {
      const scripts = Array.from(container.querySelectorAll('script'));
      if (!scripts.length) return;

      // Track executed scripts to avoid duplicates
      if (!window.NEXEFII.executedScripts) {
        window.NEXEFII.executedScripts = new Set();
      }

      // Sequentially execute to preserve order
      for (const oldScript of scripts) {
        // Create unique identifier for this script
        const scriptId = oldScript.src || oldScript.textContent.substring(0, 100);
        
        // Skip if already executed (for external scripts mainly)
        if (oldScript.src && window.NEXEFII.executedScripts.has(scriptId)) {
          console.log('[Shell] Skipping already loaded external script:', oldScript.src);
          oldScript.remove();
          continue;
        }

        const newScript = document.createElement('script');
        // Copy attributes like type, src, async
        if (oldScript.type) newScript.type = oldScript.type;
        if (oldScript.src) newScript.src = oldScript.src;
        if (oldScript.noModule) newScript.noModule = true;
        if (oldScript.async) newScript.async = false; // ensure order

        // Inline code - wrap in try-catch to prevent re-declaration errors
        if (!oldScript.src) {
          try {
            // Debug: log script content before execution
            console.log('[Shell] Executing inline script:', oldScript.textContent);
            // Wrap in IIFE to create new scope and avoid global collisions
            newScript.textContent = `(function() { try { ${oldScript.textContent} } catch(e) { if(e.message && e.message.includes('already been declared')) { console.warn('[Shell] Variable already declared, skipping'); } else { throw e; } } })();`;
            oldScript.parentNode.replaceChild(newScript, oldScript);
          } catch (e) {
            console.warn('[Shell] Script execution warning:', e);
          }
        } else {
          // For external scripts, append and wait load
          await new Promise((resolve, reject) => {
            newScript.onload = () => {
              window.NEXEFII.executedScripts.add(scriptId);
              resolve();
            };
            newScript.onerror = () => reject(new Error('Failed to load script: ' + oldScript.src));
            oldScript.parentNode.replaceChild(newScript, oldScript);
          });
        }
      }
    }

    // ============================================================================
    // Start Application
    // ============================================================================

    // Wait for DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initShell);
    } else {
      initShell();
    }

    // Register Service Worker (PWA) - DISABLED FOR DEV
    // if ('serviceWorker' in navigator) {
    //   window.addEventListener('load', () => {
    //     navigator.serviceWorker.register('/service-worker.js')
    //       .then(reg => {
    //         console.log('[Shell] Service Worker registered');
    //         // Optional manual cache clear helper
    //         window.NEXEFII.clearSWCache = async () => {
    //           if (reg.active) {
    //             reg.active.postMessage({ type: 'CLEAR_CACHE' });
    //             console.log('[Shell] CLEAR_CACHE message sent');
    //             // Provide quick visual feedback
    //             const btn = document.getElementById('btn-clear-sw');
    //             if (btn) {
    //               btn.textContent = 'SW Cleared';
    //               setTimeout(()=> btn.textContent='SW Clear', 2000);
    //             }
    //           } else {
    //             console.warn('[Shell] No active SW to clear cache');
    //           }
    //         };
    //         // Show dev button only if running on localhost
    //         if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
    //           const btn = document.getElementById('btn-clear-sw');
    //           if (btn) {
    //             btn.style.display = 'inline-block';
    //             btn.addEventListener('click', () => {
    //               window.NEXEFII.clearSWCache();
    //               // Optionally trigger a reload after short delay
    //               setTimeout(()=> location.reload(), 800);
    //             });
    //           }
    //         }
    //       })
    //       .catch(err => console.error('[Shell] Service Worker registration failed:', err));
    //   });
    // }
    console.log('[Shell] Service Worker disabled for development');
  </script>
</body>
</html>
