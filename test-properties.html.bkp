<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Test - Properties</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .test-result { padding: 15px; margin: 10px 0; border-radius: 5px; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>üîç Teste de Propriedades - NEXEFII</h1>
  
  <div id="results"></div>
  
  <h2>A√ß√µes de Teste:</h2>
  <button onclick="testLocalStorage()">1. Verificar LocalStorage</button>
  <button onclick="testProperties()">2. Verificar Propriedades</button>
  <button onclick="fixProperties()">3. Restaurar Propriedades Padr√£o</button>
  <button onclick="location.href='master-control.html'">4. Abrir Master Control</button>

  <script>
    function showResult(message, type = 'success') {
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.innerHTML = `<strong>${type === 'success' ? '‚úÖ' : '‚ùå'}</strong> ${message}`;
      document.getElementById('results').appendChild(div);
    }

    function testLocalStorage() {
      document.getElementById('results').innerHTML = '';
      try {
        const used = JSON.stringify(localStorage).length;
        const limit = 5 * 1024 * 1024; // 5MB
        const percent = ((used / limit) * 100).toFixed(2);
        showResult(`LocalStorage: ${(used / 1024).toFixed(2)} KB usados (${percent}%)`, 'success');
        
        // Listar chaves
        const keys = Object.keys(localStorage);
        showResult(`Total de chaves: ${keys.length}`, 'success');
        
        const importantKeys = keys.filter(k => k.includes('ilux') || k.includes('properties'));
        if (importantKeys.length > 0) {
          showResult(`Chaves NEXEFII encontradas: ${importantKeys.join(', ')}`, 'success');
        } else {
          showResult('Nenhuma chave NEXEFII encontrada!', 'error');
        }
      } catch (e) {
        showResult(`Erro: ${e.message}`, 'error');
      }
    }

    function testProperties() {
      document.getElementById('results').innerHTML = '';
      try {
        // Verificar se IluxProps existe
        if (typeof window.IluxProps === 'undefined') {
          showResult('IluxProps n√£o est√° carregado! Carregando...', 'error');
          loadIluxProps();
          return;
        }

        const properties = window.IluxProps.getAllProperties();
        showResult(`Total de propriedades: ${properties.length}`, properties.length > 0 ? 'success' : 'error');
        
        properties.forEach(prop => {
          const status = prop.deployed ? '‚úÖ Implantado' : '‚è≥ Pendente';
          showResult(`${prop.key} - ${prop.name} [${status}]`, 'success');
        });

        if (properties.length === 0) {
          showResult('Nenhuma propriedade encontrada. Use a op√ß√£o 3 para criar propriedades padr√£o.', 'error');
        }
      } catch (e) {
        showResult(`Erro: ${e.message}`, 'error');
      }
    }

    function loadIluxProps() {
      // Definir IluxProps b√°sico
      window.IluxProps = {
        getAllProperties: function() {
          const stored = localStorage.getItem('nexefii_properties');
          return stored ? JSON.parse(stored) : [];
        },
        saveProperty: function(property) {
          const properties = this.getAllProperties();
          const index = properties.findIndex(p => p.key === property.key);
          if (index >= 0) {
            properties[index] = property;
          } else {
            properties.push(property);
          }
          localStorage.setItem('nexefii_properties', JSON.stringify(properties));
          return { success: true };
        },
        getProperty: function(key) {
          return this.getAllProperties().find(p => p.key === key);
        }
      };
      showResult('IluxProps carregado!', 'success');
      testProperties();
    }

    function fixProperties() {
      document.getElementById('results').innerHTML = '';
      
      if (typeof window.IluxProps === 'undefined') {
        loadIluxProps();
      }

      const defaultProperties = [
        {
          key: 'iluxSaoPaulo',
          name: 'iLux S√£o Paulo',
          modules: ['engineering', 'housekeeping', 'alerts'],
          capacity: '50-100 usu√°rios',
          image: 'assets/images/hotel_sp.jpg',
          active: true,
          deployed: true
        },
        {
          key: 'iluxMiami',
          name: 'iluxMiami',
          modules: ['engineering', 'housekeeping', 'alerts'],
          capacity: '30-50 usu√°rios',
          image: 'assets/images/hotel_miami.jpg',
          active: true,
          deployed: true
        },
        {
          key: 'iluxRioDeJaneiro',
          name: 'iluxRioDeJaneiro',
          modules: ['engineering', 'housekeeping', 'alerts'],
          capacity: '50-100 usu√°rios',
          image: 'assets/images/hotel_rio.jpg',
          active: true,
          deployed: false
        }
      ];

      defaultProperties.forEach(prop => {
        window.IluxProps.saveProperty(prop);
        const status = prop.deployed ? '‚úÖ Implantado' : '‚è≥ Pendente';
        showResult(`Propriedade criada: ${prop.key} [${status}]`, 'success');
      });

      showResult('‚úÖ Propriedades padr√£o restauradas com sucesso!', 'success');
      showResult('Clique no bot√£o "4. Abrir Master Control" para ver as propriedades.', 'success');
    }

    // Auto-teste ao carregar
    window.addEventListener('load', () => {
      showResult('P√°gina de teste carregada. Use os bot√µes acima para diagnosticar problemas.', 'success');
    });
  </script>
</body>
</html>
