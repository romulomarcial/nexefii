<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagn√≥stico - PMS Reservas</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 20px;
      background: #f8fafc;
      color: #1e293b;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #3b82f6;
      margin-top: 0;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    .test-section h2 {
      margin-top: 0;
      font-size: 18px;
    }
    .test-result {
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
      border-left: 3px solid #10b981;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 3px solid #ef4444;
    }
    .warning {
      background: #fef3c7;
      color: #92400e;
      border-left: 3px solid #f59e0b;
    }
    button {
      padding: 10px 20px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 5px;
    }
    button:hover {
      background: #2563eb;
    }
    .info {
      padding: 10px;
      background: #dbeafe;
      border-radius: 6px;
      margin: 10px 0;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Diagn√≥stico do Sistema PMS - Reservas</h1>
    
    <div class="info">
      Este diagn√≥stico verifica se todos os componentes est√£o carregados e funcionando corretamente.
    </div>

    <button onclick="runDiagnostics()">‚ñ∂Ô∏è Executar Diagn√≥stico Completo</button>
    <button onclick="testModal()">ü™ü Testar Modal de Reserva</button>
    <button onclick="testTranslations()">üåç Testar Tradu√ß√µes</button>
    <button onclick="clearLogs()">üóëÔ∏è Limpar Resultados</button>

    <div id="results"></div>
  </div>

  <script>
    let resultsDiv = document.getElementById('results');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.textContent = message;
      resultsDiv.appendChild(div);
    }

    function clearLogs() {
      resultsDiv.innerHTML = '';
    }

    async function runDiagnostics() {
      clearLogs();
      
      const section = document.createElement('div');
      section.className = 'test-section';
      section.innerHTML = '<h2>üìã Resultados do Diagn√≥stico</h2>';
      resultsDiv.appendChild(section);

      // Test 1: Check if files exist
      log('‚úì Teste 1: Verificando arquivos...', 'success');
      
      const files = [
        'pms-modules.js',
        'pms-reservations.js',
        'pms-reservations-ui.js',
        'i18n.json'
      ];

      for (const file of files) {
        try {
          const response = await fetch(file, { method: 'HEAD' });
          if (response.ok) {
            log(`  ‚úì ${file} encontrado`, 'success');
          } else {
            log(`  ‚úó ${file} n√£o encontrado (${response.status})`, 'error');
          }
        } catch (e) {
          log(`  ‚úó ${file} erro ao carregar: ${e.message}`, 'error');
        }
      }

      // Test 2: Check global objects
      log('‚úì Teste 2: Verificando objetos globais...', 'success');
      
      if (typeof window.PMSModuleManager !== 'undefined') {
        log('  ‚úì PMSModuleManager carregado', 'success');
      } else {
        log('  ‚úó PMSModuleManager N√ÉO carregado', 'error');
      }

      if (typeof window.getReservationEngine !== 'undefined') {
        log('  ‚úì ReservationEngine dispon√≠vel', 'success');
      } else {
        log('  ‚úó ReservationEngine N√ÉO dispon√≠vel', 'error');
      }

      if (typeof window.RatePlanEngine !== 'undefined') {
        log('  ‚úì RatePlanEngine dispon√≠vel', 'success');
      } else {
        log('  ‚úó RatePlanEngine N√ÉO dispon√≠vel', 'error');
      }

      // Test 3: Check localStorage
      log('‚úì Teste 3: Verificando localStorage...', 'success');
      
      const lang = (localStorage.getItem('nexefii_lang') || localStorage.getItem('nexefii_lang'));
      if (lang) {
        log(`  ‚úì Idioma: ${lang}`, 'success');
      } else {
        log('  ‚ö† Idioma n√£o definido (padr√£o: pt)', 'warning');
      }

      // Test 4: Test i18n loading
      log('‚úì Teste 4: Testando carregamento de tradu√ß√µes...', 'success');
      
      try {
        const response = await fetch('i18n.json');
        const data = await response.json();
        
        const langData = data[lang || 'pt'];
        if (langData && langData.app) {
          const keys = Object.keys(langData.app);
          log(`  ‚úì ${keys.length} tradu√ß√µes carregadas para ${lang || 'pt'}`, 'success');
          
          // Check for specific keys
          const requiredKeys = ['resPageTitle', 'resNewReservation', 'resFilters'];
          const missing = requiredKeys.filter(k => !langData.app[k]);
          
          if (missing.length === 0) {
            log('  ‚úì Todas as chaves essenciais presentes', 'success');
          } else {
            log(`  ‚ö† Chaves faltando: ${missing.join(', ')}`, 'warning');
          }
        } else {
          log('  ‚úó Estrutura de tradu√ß√µes inv√°lida', 'error');
        }
      } catch (e) {
        log(`  ‚úó Erro ao carregar i18n.json: ${e.message}`, 'error');
      }

      // Test 5: Check reservation engine
      log('‚úì Teste 5: Testando ReservationEngine...', 'success');
      
      try {
        const engine = window.getReservationEngine('test_property');
        log('  ‚úì Engine instanciado com sucesso', 'success');
        
        const testRes = {
          guestName: 'Teste',
          guestEmail: 'teste@test.com',
          guestPhone: '11999999999',
          checkInDate: '2025-11-10',
          checkOutDate: '2025-11-13',
          roomTypeId: 'standard',
          adults: 2,
          children: 0,
          ratePerNight: 350,
          totalAmount: 1050,
          source: 'direct',
          status: 'confirmed'
        };
        
        const created = engine.createReservation(testRes);
        log(`  ‚úì Reserva teste criada: ${created.confirmationNumber}`, 'success');
        
        // Clean up
        const idx = engine.reservations.findIndex(r => r.id === created.id);
        if (idx >= 0) {
          engine.reservations.splice(idx, 1);
          engine.saveReservations();
        }
        
      } catch (e) {
        log(`  ‚úó Erro no ReservationEngine: ${e.message}`, 'error');
      }

      // Test 6: Test RatePlanEngine
      log('‚úì Teste 6: Testando RatePlanEngine...', 'success');
      
      try {
        const ratePlan = new window.RatePlanEngine();
        const rate = ratePlan.calculateRate('standard', '2025-11-10', '2025-11-13', 'rack', 2);
        
        if (rate && rate.finalRate) {
          log(`  ‚úì C√°lculo de tarifa: R$ ${rate.finalRate.toFixed(2)}`, 'success');
        } else {
          log('  ‚úó C√°lculo de tarifa retornou null', 'error');
        }
      } catch (e) {
        log(`  ‚úó Erro no RatePlanEngine: ${e.message}`, 'error');
      }

      log('‚úÖ Diagn√≥stico completo!', 'success');
    }

    function testModal() {
      clearLogs();
      
      log('ü™ü Testando modal de reserva...', 'success');
      
      // Open popup
      const popup = window.open('pms-reservations.html', '_blank', 'width=1400,height=900');
      
      if (popup) {
        log('  ‚úì Popup aberta', 'success');
        log('  ‚Ñπ Aguarde a p√°gina carregar...', 'info');
        
        // Wait for load
        setTimeout(() => {
          try {
            // Check if elements exist
            const btnNew = popup.document.getElementById('btnNewReservation');
            const modal = popup.document.getElementById('newReservationModal');
            
            if (btnNew) {
              log('  ‚úì Bot√£o "Nova Reserva" encontrado', 'success');
            } else {
              log('  ‚úó Bot√£o "Nova Reserva" N√ÉO encontrado', 'error');
            }
            
            if (modal) {
              log('  ‚úì Modal encontrado no DOM', 'success');
            } else {
              log('  ‚úó Modal N√ÉO encontrado no DOM', 'error');
            }
            
            // Try to click
            if (btnNew) {
              log('  ‚Üí Clicando no bot√£o...', 'info');
              btnNew.click();
              
              setTimeout(() => {
                if (modal && modal.style.display === 'flex') {
                  log('  ‚úì Modal abriu com sucesso!', 'success');
                } else {
                  log('  ‚úó Modal n√£o abriu ap√≥s click', 'error');
                  log('  ‚Ñπ Abra o console da popup (F12) para ver erros', 'warning');
                }
              }, 500);
            }
            
          } catch (e) {
            log(`  ‚úó Erro ao testar modal: ${e.message}`, 'error');
            log('  ‚Ñπ A popup pode ter bloqueado o acesso por seguran√ßa', 'warning');
          }
        }, 2000);
        
      } else {
        log('  ‚úó Popup bloqueada pelo navegador', 'error');
        log('  ‚Ñπ Permita popups para este site', 'warning');
      }
    }

    async function testTranslations() {
      clearLogs();
      
      log('üåç Testando tradu√ß√µes...', 'success');
      
      const langs = ['pt', 'en', 'es'];
      
      try {
        const response = await fetch('i18n.json');
        const data = await response.json();
        
        for (const lang of langs) {
          if (data[lang] && data[lang].app) {
            const keys = Object.keys(data[lang].app);
            const resKeys = keys.filter(k => k.startsWith('res'));
            log(`  ‚úì ${lang.toUpperCase()}: ${resKeys.length} tradu√ß√µes de reservas`, 'success');
            
            // Test specific keys
            const testKeys = ['resPageTitle', 'resNewReservation', 'resFilters'];
            const values = testKeys.map(k => data[lang].app[k]).filter(v => v);
            
            if (values.length === testKeys.length) {
              log(`    Exemplos: "${values.join('", "')}"`, 'info');
            }
          } else {
            log(`  ‚úó ${lang.toUpperCase()}: estrutura inv√°lida`, 'error');
          }
        }
      } catch (e) {
        log(`  ‚úó Erro: ${e.message}`, 'error');
      }
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      setTimeout(() => {
        log('üìã P√°gina de diagn√≥stico carregada. Clique em "Executar Diagn√≥stico Completo" para come√ßar.', 'info');
      }, 100);
    });
  </script>
</body>
</html>
