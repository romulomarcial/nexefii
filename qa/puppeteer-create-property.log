[console:log] ‚úÖ PropertyDatabase loaded successfully
[console:log] ‚úÖ Router.js loaded (v1.0.0)
[console:log] ‚úÖ PWA Installer loaded (Service Worker DISABLED for stability)
[console:log] ‚úÖ PWA Installer loaded
[console:log] [Shell] Service Worker disabled for development
[console:log] [Shell] Initializing NEXEFII Shell...
[console:log] [Shell] Initializing i18n...
[console:log] [I18n] Legacy monolithic loaded for seeding
[console:log] [I18n] Segment loaded: common (pt)
[console:log] [I18n] Segment loaded: wizard (pt)
[console:log] [I18n] Segment loaded: dashboard (pt)
[console:log] [I18n] Segment loaded: rooms (pt)
[console:log] [I18n] Segment loaded: frontdesk (pt)
[console:log] [I18n] Segment loaded: reservations (pt)
[console:log] [I18n] Segment loaded: common (en)
[console:log] [I18n] Segment loaded: wizard (en)
[console:log] üíæ Install prompt available
[console:info] Banner not shown: beforeinstallpromptevent.preventDefault() called. The page must call beforeinstallpromptevent.prompt() to show the banner.
[console:log] [I18n] Segment loaded: dashboard (en)
[console:log] [I18n] Segment loaded: rooms (en)
[console:log] [I18n] Segment loaded: frontdesk (en)
[console:log] [I18n] Segment loaded: reservations (en)
[console:log] [I18n] Segment loaded: common (es)
[console:log] [I18n] Segment loaded: wizard (es)
[console:log] [I18n] Segment loaded: dashboard (es)
[console:log] [I18n] Segment loaded: rooms (es)
[console:log] [I18n] Segment loaded: frontdesk (es)
[console:log] [I18n] Segment loaded: reservations (es)
[console:log] [I18n] Languages ready: JSHandle@array
[console:log] [I18n] Applied translations to 4 elements (only real translations or defaults replaced)
[console:log] [Shell] i18n initialized
[console:log] [Shell] User session loaded: demo@example.com
[console:log] [Router] Router initialized JSHandle@object
[console:log] [Router] Property resolver set JSHandle@object
[console:log] [Router] Auth guard set JSHandle@object
[console:log] [Router] Property access guard set JSHandle@object
[console:log] [Router] Global middleware added JSHandle@object
[console:log] [Router] Route registered JSHandle@object
[console:log] [Router] Route registered JSHandle@object
[console:log] [Router] Route registered JSHandle@object
[console:log] [Router] Route registered JSHandle@object
[console:log] [Router] Route registered JSHandle@object
[console:log] [Router] Route registered JSHandle@object
[console:log] [Router] Route registered JSHandle@object
[console:log] [Router] Route matched JSHandle@object
[console:log] [Shell] Auth guard: PASS
[console:log] [Router] Router started JSHandle@object
[console:log] [Shell] Shell initialized successfully
[console:log] [I18n] Applied translations to 1 elements (only real translations or defaults replaced)
[console:log] [Shell] Loading page: home 
[console:log] [Shell] Executing inline script: 
  async function initHomePage() {
    console.log('[Home] Initializing home page');
    
    // Subscribe to language changes if i18n is available
    if (window.NEXEFII?.i18n) {
      window.NEXEFII.i18n.onChange((lang) => {
        console.log('[Home] Language changed to:', lang);
        // Re-render the page to update translations
        renderHomePage();
      });
    } else {
      console.warn('[Home] I18n not available');
    }
    
    // Initial render
    renderHomePage();
  }
  
  function renderHomePage() {
    // Force reload user session from localStorage to pick up newly created properties
    const sessionData = localStorage.getItem('nexefii_session');
    if (sessionData) {
      window.NEXEFII.currentUser = JSON.parse(sessionData);
    }
    
    const user = window.NEXEFII.currentUser;
    const container = document.getElementById('properties-container');
    
    if (!user || !user.properties || user.properties.length === 0) {
      // Empty state
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üè®</div>
          <h2 class="empty-state-title" data-i18n="home.empty.title">Nenhuma Propriedade Encontrada</h2>
          <p class="empty-state-message" data-i18n="home.empty.message">
            Voc√™ ainda n√£o tem propriedades cadastradas no sistema.
          </p>
          <a href="/wizard" class="btn-primary" data-router-link>
            <span data-i18n="home.empty.cta">Adicionar Primeira Propriedade</span>
          </a>
        </div>
      `;
      if (window.NEXEFII?.i18n) window.NEXEFII.i18n.applyToDOM(container);
      return;
    }
    
    // Render properties grid
    container.innerHTML = `
      <div class="properties-grid">
        ${user.properties.map(property => `
          <a href="/property/${property.slug}/dashboard" class="property-card" data-router-link>
            <div class="property-card-image-wrapper">
              <img class="property-card-image" src="${property.image || '/assets/images/default-property.jpg'}" alt="${property.name}" loading="lazy" />
            </div>
            <div class="property-card-icon">${property.icon || 'üè®'}</div>
            <h3 class="property-card-title">${property.name}</h3>
            <div class="property-card-modules">
              ${(property.modules && property.modules.length > 0)
                ? property.modules.map(m => `<span class='property-module-badge'>${m}</span>`).join(' ')
                : '<span style="color:#999;" data-i18n="home.card.noModules">Nenhum m√≥dulo</span>'}
            </div>
            <p class="property-card-description">
              ${property.description || '<span data-i18n="home.card.defaultDescription">Clique para acessar o painel de controle</span>'}
            </p>
            <div class="property-card-stats">
              <div class="property-stat">
                <div class="property-stat-value">${property.stats?.rooms || 0}</div>
                <div class="property-stat-label" data-i18n="home.card.stats.rooms">Quartos</div>
              </div>
              <div class="property-stat">
                <div class="property-stat-value">${property.stats?.occupancy || 0}%</div>
                <div class="property-stat-label" data-i18n="home.card.stats.occupancy">Ocupa√ß√£o</div>
              </div>
              <div class="property-stat">
                <div class="property-stat-value">${property.stats?.reservations || 0}</div>
                <div class="property-stat-label" data-i18n="home.card.stats.reservations">Reservas</div>
              </div>
            </div>
          </a>
        `).join('')}
      </div>
    `;
    if (window.NEXEFII?.i18n) window.NEXEFII.i18n.applyToDOM(container);
    
    console.log('[Home] Home page rendered with', user.properties.length, 'properties');
  }

[console:log] [Shell] Page loaded successfully: home
[console:log] [Router] Route handler executed JSHandle@object
[console:log] [Router] Navigation requested JSHandle@object
[console:log] [Router] Route matched JSHandle@object
[console:log] [Shell] Auth guard: PASS
[console:log] [Router] Route matched JSHandle@object
[console:log] [Shell] Auth guard: PASS
[console:log] [I18n] Applied translations to 1 elements (only real translations or defaults replaced)
[console:log] [I18n] Applied translations to 1 elements (only real translations or defaults replaced)
[console:log] [Shell] Loading page: wizard 
[console:log] [Shell] Loading page: wizard 
[console:log] [Shell] Skipping already loaded external script: http://localhost:8004/core/i18n/I18nManager.js
[console:log] [Shell] Executing inline script: 
  // Initialize I18n for wizard page
  (function(){
    try {
      window.__nexefii_i18n = window.__nexefii_i18n || new I18nManager();
      (async function(){
        try {
          await window.__nexefii_i18n.loadTranslations();
          window.NEXEFII = window.NEXEFII || {};
          window.NEXEFII.i18n = window.__nexefii_i18n;
          await window.__nexefii_i18n.loadSegment(null,'wizard');
          window.__nexefii_i18n.applyToDOM(document);
          var t = document.querySelector('title'); if(t) t.textContent = window.__nexefii_i18n.t('wizard.title');
        } catch(e){ console.warn('[I18n] wizard init failed', e); }
      })();
    } catch(e){ console.warn('[I18n] wizard boot error', e); }
  })();

[console:log] [Shell] Executing inline script: 
  // Initialize I18n for wizard page
  (function(){
    try {
      window.__nexefii_i18n = window.__nexefii_i18n || new I18nManager();
      (async function(){
        try {
          await window.__nexefii_i18n.loadTranslations();
          window.NEXEFII = window.NEXEFII || {};
          window.NEXEFII.i18n = window.__nexefii_i18n;
          await window.__nexefii_i18n.loadSegment(null,'wizard');
          window.__nexefii_i18n.applyToDOM(document);
          var t = document.querySelector('title'); if(t) t.textContent = window.__nexefii_i18n.t('wizard.title');
        } catch(e){ console.warn('[I18n] wizard init failed', e); }
      })();
    } catch(e){ console.warn('[I18n] wizard boot error', e); }
  })();

[console:warn] [I18n] wizard boot error JSHandle@error
[console:log] [Shell] Skipping already loaded external script: http://localhost:8004/core/i18n/I18nManager.js
[console:log] [Shell] Executing inline script: 
  // Load page-specific i18n JSONs from ../i18n/<lang>/ (fallback-aware)
  async function loadPageI18n() {
    const savedLang = (localStorage.getItem('nexefii_language') || localStorage.getItem('nexefii_lang') || navigator.language || 'pt').split('-')[0];
    const langsToTry = [savedLang, 'pt', 'en', 'es'];
    window.__PAGE_I18N = window.__PAGE_I18N || {};

    for (const lang of langsToTry) {
      try {
        const base = `../i18n/${lang}`;
        const commonRes = await fetch(`${base}/common.json`, { cache: 'no-store' });
        const pageRes = await fetch(`${base}/wizard.json`, { cache: 'no-store' });

        const common = (commonRes.ok) ? await commonRes.json() : {};
        const page = (pageRes.ok) ? await pageRes.json() : {};

        // Merge under language key
        window.__PAGE_I18N[lang] = Object.assign({}, common, page);

        // Stop after first successful language load
        if (Object.keys(window.__PAGE_I18N[lang]).length) return;
      } catch (e) {
        // try next language
      }
    }

    // if nothing loaded, ensure object exists to avoid runtime errors
    window.__PAGE_I18N = window.__PAGE_I18N || {};
  }

  // Populate language selector using global i18n manager if available
  function populateLanguageSelector() {
    const sel = document.getElementById('language');
    if (!sel) return;
    try {
      if (window.NEXEFII && window.NEXEFII.i18n && typeof window.NEXEFII.i18n.getLanguageOptions === 'function') {
        const opts = window.NEXEFII.i18n.getLanguageOptions();
        sel.innerHTML = '';
        opts.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.code; // short code like 'pt','en','es'
          opt.textContent = `${o.flag} ${o.name}`;
          sel.appendChild(opt);
        });
        // set current value
        sel.value = (window.NEXEFII?.i18n?.getLanguage?.() || window.NEXEFII?.i18n?.currentLang) || (navigator.language || 'pt').split('-')[0];
      }
    } catch (e) { /* ignore */ }
  }

  function resolveI18nKey(path, lang) {
    try {
      if (!window.__PAGE_I18N) return null;
      const langObj = window.__PAGE_I18N[lang] || window.__PAGE_I18N[lang.split('-')[0]] || window.__PAGE_I18N['en'] || {};
      const parts = path.split('.');
      let cur = langObj;
      for (const p of parts) {
        if (cur && Object.prototype.hasOwnProperty.call(cur, p)) cur = cur[p];
        else return null;
      }
      return (typeof cur === 'string') ? cur : null;
    } catch (e) {
      return null;
    }
  }

  function applyI18nToPage(lang) {
    try {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const txt = resolveI18nKey(key, lang);
        if (txt) {
          // If element has placeholder attribute, set it instead of innerText for inputs
          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') {
            el.placeholder = txt;
          } else {
            el.innerText = txt;
          }
        }
      });
    } catch (e) {
      // ignore
    }
  }

  (async function initWizardPage(){
    // Prefer the core I18nManager when available (recommended). If not present, fall back to legacy monolithic loader.
    try {
      if (window.NEXEFII && window.NEXEFII.i18n && typeof window.NEXEFII.i18n.loadTranslations === 'function') {
        await window.NEXEFII.i18n.loadTranslations();
        window.NEXEFII.i18n.applyToDOM(document);
      } else {
        await loadPageI18n();
        const savedLang = (localStorage.getItem('nexefii_language') || localStorage.getItem('nexefii_lang') || navigator.language || 'pt').split('-')[0];
        applyI18nToPage(savedLang);
      }
    } catch (e) {
      // continue even if i18n failed
      console.warn('[Wizard] i18n initialization issue', e?.message || e);
    }

    // Populate language selector (if available) before initializing wizard
    try { populateLanguageSelector(); } catch(e) {}

    // Initialize Wizard Manager (idempotent / safe re-entry)
    if (typeof WizardManager === 'undefined') {
      console.error('[Wizard] WizardManager not loaded');
    }
    // Reuse existing instance if present to avoid redeclaration errors on re-navigation
    window.wizard = (window.wizard && window.wizard instanceof WizardManager)
      ? window.wizard
      : new WizardManager();
    wizard = window.wizard; // create global binding
  })();

  // Diagnostic: log i18n status and attempt a forced apply if translations appear available
  (function _wizardI18nDiagnostics(){
      /**
       * Inline i18n fallback: try multiple candidate URLs for monolithic and segment JSONs
       * If a JSON is found, merge into window.__PAGE_I18N and apply translations.
       */
      async function applyInlineI18nFallback(preferredLang) {
        const lang = (preferredLang || (navigator.language || 'pt')).split('-')[0];
        const candidates = [
          '/i18n/i18n.json',
          '/i18n.json',
          '../i18n/i18n.json',
          '../i18n.json',
          'i18n/i18n.json',
          './i18n.json',
          'i18n.json',
          '../../i18n.json'
        ];

        // Try monolithic
        for (const url of candidates) {
          try {
            const r = await fetch(url, { cache: 'no-store' });
            if (r && r.ok) {
              try {
                const json = await r.json();
                // If json contains languages at top-level, use it
                window.__PAGE_I18N = window.__PAGE_I18N || {};
                if (json[lang]) {
                  window.__PAGE_I18N[lang] = Object.assign({}, json[lang]);
                } else if (json.common || json["wizard"]) {
                  // monolithic merged under language keys? try assign
                  window.__PAGE_I18N[lang] = Object.assign({}, json[lang] || json);
                }
                console.log('[Wizard][i18n][fallback] Loaded monolithic:', url);
                applyI18nToPage(lang);
                return true;
              } catch (e) {
                console.warn('[Wizard][i18n][fallback] JSON parse failed', url, e);
              }
            }
          } catch (e) { /* ignore and try next */ }
        }

        // Try segment-based wizard.json under multiple base paths
        const baseCandidates = ['/i18n', '../i18n', './i18n', 'i18n', '../../i18n'];
        for (const base of baseCandidates) {
          const url = `${base}/${lang}/wizard.json`;
          try {
            const r = await fetch(url, { cache: 'no-store' });
            if (r && r.ok) {
              const pageJson = await r.json();
              window.__PAGE_I18N = window.__PAGE_I18N || {};
              window.__PAGE_I18N[lang] = Object.assign({}, pageJson);
              console.log('[Wizard][i18n][fallback] Loaded segment:', url);
              applyI18nToPage(lang);
              return true;
            }
          } catch (e) { /* try next */ }
        }

        console.warn('[Wizard][i18n][fallback] No i18n candidate found for', lang);
        return false;
      }
    setTimeout(() => {
      try {
        console.group('[Wizard][i18n] Diagnostics');
        console.log('NEXEFII.i18n present:', !!window.NEXEFII?.i18n);
        console.log('i18n currentLang:', window.NEXEFII?.i18n?.getLanguage?.() || window.NEXEFII?.i18n?.currentLang);
        console.log('i18n translations keys:', Object.keys(window.NEXEFII?.i18n?.translations || {}));
        console.log('__PAGE_I18N keys:', Object.keys(window.__PAGE_I18N || {}));
        const sel = document.getElementById('language');
        console.log('language selector value:', sel?.value);

        // If global manager exists and has translations loaded for current lang, re-apply
        const lang = window.NEXEFII?.i18n?.getLanguage?.() || (sel?.value || '').split('-')[0];
        if (window.NEXEFII?.i18n && window.NEXEFII.i18n.translations && window.NEXEFII.i18n.translations[lang]) {
          console.log(`[Wizard][i18n] Found translations for '${lang}', applying to DOM.`);
          try { window.NEXEFII.i18n.applyToDOM(document); } catch(e){ console.warn('[Wizard][i18n] apply error', e); }
        } else {
          console.log('[Wizard][i18n] Translations for current lang not yet available. Will try inline fallback.');
          try { applyInlineI18nFallback(lang); } catch(e) { console.warn('[Wizard][i18n] inline fallback failed', e); }
        }
        console.groupEnd();
      } catch (e) { console.warn('[Wizard][i18n] diagnostics failed', e); }
    }, 450);
  })();

  // ============================================================================
  // Step Navigation
  // ============================================================================

  function updateUI() {
    // Guard: ensure wizard is ready before updating the UI. Some inline handlers
    // or early DOM events may invoke updateUI before the async initializer finishes.
    if (typeof window.wizard === 'undefined' || window.wizard == null) return;
    const wizard = window.wizard;

    // Update progress steps
    const steps = document.querySelectorAll('.progress-step');
    steps.forEach((step, index) => {
      const stepNum = index + 1;
      const circle = step.querySelector('.step-circle');
      const label = step.querySelector('.step-label');

      if (stepNum < wizard.currentStep) {
        circle.classList.add('completed');
        circle.classList.remove('active');
        circle.textContent = '‚úì';
      } else if (stepNum === wizard.currentStep) {
        circle.classList.add('active');
        circle.classList.remove('completed');
        circle.textContent = stepNum;
        label.classList.add('active');
      } else {
        circle.classList.remove('active', 'completed');
        circle.textContent = stepNum;
        label.classList.remove('active');
      }
    });

    // Update step content visibility
    document.querySelectorAll('.step-content').forEach((content, index) => {
      // Step order: 1 (basic), 2 (details), modules, 3 (rooms), 4 (settings), 5 (seed), 6 (review)
      if (
        (wizard.currentStep === 1 && content.id === 'step-1') ||
        (wizard.currentStep === 2 && content.id === 'step-2') ||
        (wizard.currentStep === 3 && content.id === 'step-modules') ||
        (wizard.currentStep === 4 && content.id === 'step-3') ||
        (wizard.currentStep === 5 && content.id === 'step-4') ||
        (wizard.currentStep === 6 && content.id === 'step-5') ||
        (wizard.currentStep === 7 && content.id === 'step-6')
      ) {
        content.classList.add('active');
      } else {
        content.classList.remove('active');
      }
    });

    // Update buttons
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');

    btnPrev.style.display = wizard.isFirstStep() ? 'none' : 'block';
    if (window.NEXEFII?.i18n) {
      const label = wizard.isLastStep() ? window.NEXEFII.i18n.t('wizard.buttons.create') : window.NEXEFII.i18n.t('wizard.buttons.next');
      // Keep arrow with text, but don't break data-i18n spans
      const span = btnNext.querySelector('[data-i18n]');
      if (span) span.textContent = label;
    } else {
      btnNext.textContent = wizard.isLastStep() ? 'Concluir ‚Üí' : 'Pr√≥ximo ‚Üí';
    }
    btnNext.style.display = wizard.isLastStep() ? 'none' : 'block';

    // Update step-specific UI
    if (wizard.currentStep === 4) {
      document.getElementById('total-rooms-needed').textContent = wizard.data.roomsCount || 0;
      renderCategories();
    }

    if (wizard.currentStep === 7) {
      updateReview();
    }

    // Apply translations after DOM updates
    try {
      const wc = document.querySelector('.wizard-content');
      if (wc && window.NEXEFII?.i18n) window.NEXEFII.i18n.applyToDOM(wc);
    } catch(e) { console.warn('[Wizard] i18n apply error', e); }
  }

  function nextStep() {
    if (wizard.nextStep()) {
      clearErrors();
      updateUI();
    } else {
      showErrors();
    }
  }

  function prevStep() {
    if (wizard.prevStep()) {
      clearErrors();
      updateUI();
    }
  }

  // Make functions globally accessible for onclick handlers
  window.nextStep = nextStep;
  window.prevStep = prevStep;
  // Expose room template/category functions for inline onclick handlers
  window.applyTemplate = applyTemplate;
  window.addCategory = addCategory;
  window.removeCategory = removeCategory;

  // ============================================================================
  // Form Handling
  // ============================================================================

  function clearErrors() {
    document.querySelectorAll('.form-error').forEach(el => {
      el.classList.remove('show');
      el.textContent = '';
    });
    document.querySelectorAll('.form-input, .form-select').forEach(el => {
      el.classList.remove('error');
    });
  }

  function showErrors() {
    const errors = wizard.getValidationErrors();
    
    for (const [field, message] of Object.entries(errors)) {
      const errorEl = document.getElementById(`error-${field}`);
      const inputEl = document.getElementById(field);
      
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.add('show');
      }
      
      if (inputEl) {
        inputEl.classList.add('error');
      }
    }
  }

  // Bind input events
  ['name', 'description', 'type', 'roomsCount', 'city', 'state', 'street', 'zip', 'country', 
   'currency', 'timezone', 'checkInTime', 'checkOutTime', 'language'].forEach(field => {
    const el = document.getElementById(field);
    if (el) {
      el.addEventListener('input', (e) => {
        const value = e.target.value;
        
        if (field === 'roomsCount') {
          wizard.updateData(field, parseInt(value) || 0);
        } else if (field.startsWith('address.')) {
          wizard.updateData(`address.${field.split('.')[1]}`, value);
        } else if (['city', 'state', 'street', 'zip', 'country'].includes(field)) {
          wizard.updateData(`address.${field}`, value);
        } else if (['currency', 'timezone', 'language', 'checkInTime', 'checkOutTime'].includes(field)) {
          wizard.updateData(`settings.${field}`, value);
        } else {
          wizard.updateData(field, value);
        }

        // Auto-update slug field
        if (field === 'name') {
          document.getElementById('slug').value = wizard.data.slug;
        }
      });
    }
  });

  // When the language select changes, notify the global i18n manager so
  // the entire page (including wizard headers/step labels) is re-rendered.
  const langSelect = document.getElementById('language');
  if (langSelect) {
    langSelect.addEventListener('change', (e) => {
      const val = (e.target.value || '').split('-')[0];
      try {
        if (window.NEXEFII && window.NEXEFII.i18n && typeof window.NEXEFII.i18n.setLanguage === 'function') {
          window.NEXEFII.i18n.setLanguage(val);
        } else {
          // Fallback for legacy pages: apply translations locally
          applyI18nToPage(val);
        }
      } catch (err) {
        console.warn('[Wizard] language change handler error', err);
      }
    });
  }

  // Icon selector
  document.querySelectorAll('.icon-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
      wizard.updateData('icon', option.dataset.icon);
    });
  });

  // Seed data checkboxes
  ['createSampleRooms', 'createSampleGuests', 'createSampleReservations'].forEach(field => {
    const el = document.getElementById(field);
    if (el) {
      el.addEventListener('change', (e) => {
        wizard.updateData(`seedData.${field}`, e.target.checked);
      });
    }
  });

  // Module selection checkboxes
  const moduleIds = [
    'module-ems', 'module-bms', 'module-automation', 'module-analytics',
    'module-pms', 'module-iot', 'module-access', 'module-other'
  ];
  moduleIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('change', () => {
        wizard.data.modules = moduleIds
          .filter(mid => document.getElementById(mid)?.checked)
          .map(mid => document.getElementById(mid).value);
        updateReview();
      });
    }
  });

  // ============================================================================
  // Image Upload Management
  // ============================================================================

  // Tab switching
  document.querySelectorAll('.image-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const targetTab = this.dataset.tab;
      
      // Update active tab button
      document.querySelectorAll('.image-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // Update active tab content
      document.querySelectorAll('.image-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${targetTab}-tab`).classList.add('active');
    });
  });

  // Gallery image selection
  document.querySelectorAll('.gallery-image').forEach(img => {
    img.addEventListener('click', function() {
      // Remove previous selection
      document.querySelectorAll('.gallery-image').forEach(i => i.classList.remove('selected'));
      
      // Select this image
      this.classList.add('selected');
      
      // Update hidden field
      const imagePath = this.dataset.image;
      document.getElementById('propertyImage').value = imagePath;
      wizard.updateData('image', imagePath);
    });
  });

  // File upload
  const fileInput = document.getElementById('image-file');
  const uploadPreview = document.getElementById('upload-preview');
  const uploadLoading = document.getElementById('upload-loading');
  const uploadArea = document.querySelector('.upload-area');
  
  // Function to process image file
  function processImageFile(file) {
    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
      alert('‚úñ Arquivo muito grande! M√°ximo 5MB.');
      return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
      alert('‚úñ Por favor, selecione uma imagem v√°lida.');
      return;
    }
    
    // Show loading
    if (uploadLoading) {
      uploadLoading.classList.add('show');
      uploadPreview.classList.remove('show');
    }
    
    // Read and display preview
    const reader = new FileReader();
    reader.onload = function(event) {
      const imageData = event.target.result;
      
      // Hide loading, show preview
      if (uploadLoading) uploadLoading.classList.remove('show');
      
      uploadPreview.innerHTML = `<img src="${imageData}" alt="Preview">`;
      uploadPreview.classList.add('show');
      
      // Update hidden field
      document.getElementById('propertyImage').value = imageData;
      wizard.updateData('image', imageData);
    };
    reader.onerror = function() {
      if (uploadLoading) uploadLoading.classList.remove('show');
      alert('‚úñ Erro ao processar imagem.');
    };
    reader.readAsDataURL(file);
  }
  
  fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    processImageFile(file);
  });

  // Drag and drop handlers
  if (uploadArea) {
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        processImageFile(files[0]);
      }
    });
  }

  // URL preview
  const urlInput = document.getElementById('image-url');
  const urlPreview = document.getElementById('url-preview');
  const btnPreviewUrl = document.getElementById('btn-preview-url');
  
  btnPreviewUrl.addEventListener('click', function() {
    const url = urlInput.value.trim();
    if (!url) {
      alert('‚úñ Digite uma URL v√°lida.');
      return;
    }
    
    // Create image element to test URL
    const img = new Image();
    img.onload = function() {
      urlPreview.innerHTML = `<img src="${url}" alt="Preview">`;
      urlPreview.classList.add('show');
      
      // Update hidden field
      document.getElementById('propertyImage').value = url;
      wizard.updateData('image', url);
    };
    img.onerror = function() {
      alert('‚úñ N√£o foi poss√≠vel carregar a imagem. Verifique a URL.');
    };
    img.src = url;
  });

  // ============================================================================
  // Room Categories
  // ============================================================================

  function applyTemplate(templateName) {
    wizard.applyTemplate(templateName);
    renderCategories();
  }

  function renderCategories() {
    const container = document.getElementById('category-list');
    if (!container) {
      console.warn('[Wizard] category-list container not found');
      return;
    }
    
    const categories = wizard.data.roomCategories;

    if (!categories || categories.length === 0) {
      let emptyMessage = 'Nenhuma categoria adicionada. Use um template ou adicione manualmente.';
      try {
        if (window.NEXEFII?.i18n) {
          emptyMessage = window.NEXEFII.i18n.t('wizard.rooms.emptyMessage') || emptyMessage;
        }
      } catch(e) {
        console.warn('[Wizard] Error getting translation:', e);
      }
      container.innerHTML = `<p style="color: #999; text-align: center; padding: 2rem;">${emptyMessage}</p>`;
      return;
    }

    // Get translations
  let removeLabel = 'Remover';
  let priceLabel = 'Pre√ßo:';
    let quantityLabel = 'Quantidade:';
    let roomsLabel = 'quartos';
    
    try {
      if (window.NEXEFII?.i18n) {
        removeLabel = window.NEXEFII.i18n.t('wizard.rooms.removeButton') || removeLabel;
        priceLabel = window.NEXEFII.i18n.t('wizard.rooms.priceLabel') || priceLabel;
        quantityLabel = window.NEXEFII.i18n.t('wizard.rooms.quantityLabel') || quantityLabel;
        roomsLabel = window.NEXEFII.i18n.t('wizard.rooms.roomsLabel') || roomsLabel;
      }
    } catch(e) {
      console.warn('[Wizard] Error getting category translations:', e);
    }

    // Get currency symbol based on current language (handle locales like 'pt-BR', 'en-US')
    const currentLang = (window.NEXEFII?.i18n?.getLanguage && window.NEXEFII.i18n.getLanguage()) || (navigator.language || 'pt');
    let currencySymbol = 'R$';
    try {
      if (/^pt/i.test(currentLang)) currencySymbol = 'R$';
      else if (/^en/i.test(currentLang)) currencySymbol = '$';
      else if (/^es/i.test(currentLang)) currencySymbol = '‚Ç¨';
    } catch (e) { /* keep default */ }

    container.innerHTML = categories.map((cat, index) => `
      <div class="category-card">
        <div class="category-card-header">
          <div class="category-name">${cat.name}</div>
          <button class="btn-remove" onclick="removeCategory(${index})">${removeLabel}</button>
        </div>
        <div class="form-grid">
          <div>
            <strong>${priceLabel}</strong> ${currencySymbol} ${cat.price}
          </div>
          <div>
            <strong>${quantityLabel}</strong> ${cat.count} ${roomsLabel}
          </div>
        </div>
      </div>
    `).join('');
  }

  function addCategory() {
    const name = prompt('Nome da categoria:');
    if (!name) return;

  const price = parseInt(prompt('Pre√ßo por noite (R$):')) || 0;
    const count = parseInt(prompt('Quantidade de quartos:')) || 0;

    wizard.addRoomCategory({ name, price, count, capacity: 2 });
    renderCategories();
  }

  function removeCategory(index) {
    wizard.removeRoomCategory(index);
    renderCategories();
  }

  // ============================================================================
  // Review
  // ============================================================================

  function updateReview() {
    const data = wizard.getData();

    // Update property image
    const reviewImage = document.getElementById('review-image');
    if (reviewImage && data.image) {
      reviewImage.src = data.image;
    }

    document.getElementById('review-name').textContent = data.name;
    document.getElementById('review-slug').textContent = data.slug;
    document.getElementById('review-type').textContent = data.type;
    document.getElementById('review-roomsCount').textContent = data.roomsCount;
    document.getElementById('review-currency').textContent = data.settings.currency;
    document.getElementById('review-checktimes').textContent = 
      `${data.settings.checkInTime} / ${data.settings.checkOutTime}`;

    // Render categories
    const categoriesHTML = data.roomCategories.map(cat => `
      <div class="review-item">
        <span class="review-label">${cat.name}</span>
        <span class="review-value">${cat.count} quartos √ó R$ ${cat.price}</span>
      </div>
    `).join('');
    document.getElementById('review-categories').innerHTML = categoriesHTML;

    // Render selected modules
    const modulesContainer = document.getElementById('review-modules');
    if (modulesContainer) {
      if (data.modules && data.modules.length > 0) {
        modulesContainer.innerHTML = data.modules.map(m => `<span class="review-value">${m}</span>`).join(', ');
      } else {
  modulesContainer.innerHTML = '<span style="color:#999;">Nenhum m√≥dulo selecionado</span>';
      }
    }
  }

  // ============================================================================
  // Create Property
  // ============================================================================

  function showProgressModal() {
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'progress-modal';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    `;

    // Create modal content
    const modal = document.createElement('div');
    modal.style.cssText = `
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      text-align: center;
      color: white;
    `;

      modal.innerHTML = `
      <div style="font-size: 48px; margin-bottom: 20px;">üè®</div>
      <h2 style="margin: 0 0 10px; font-size: 24px; font-weight: 600;">Criando sua propriedade</h2>
      <p id="progress-status" style="margin: 0 0 30px; font-size: 16px; opacity: 0.9;">Preparando...</p>
      
      <div style="background: rgba(255, 255, 255, 0.2); border-radius: 10px; height: 12px; overflow: hidden; margin-bottom: 20px;">
        <div id="progress-bar" style="background: white; height: 100%; width: 0%; transition: width 0.5s ease-out; border-radius: 10px;"></div>
      </div>
      
      <div id="progress-steps" style="font-size: 14px; opacity: 0.8; line-height: 1.6;">
        <div id="step-1">‚Ä¢ Criando estrutura...</div>
        <div id="step-2">‚Ä¢ Gerando quartos...</div>
        <div id="step-3">‚Ä¢ Criando h√≥spedes...</div>
        <div id="step-4">‚Ä¢ Gerando reservas...</div>
        <div id="step-5">‚Ä¢ Salvando dados...</div>
      </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    return {
      updateProgress: (percent, status) => {
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-status').textContent = status;
      },
      completeStep: (stepNum) => {
        const stepEl = document.getElementById(`step-${stepNum}`);
        if (stepEl) {
          stepEl.innerHTML = stepEl.innerHTML.replace('‚Ä¢', '‚úì');
          stepEl.style.opacity = '1';
          stepEl.style.fontWeight = '600';
        }
      },
      showSuccess: (propertyName) => {
        modal.innerHTML = `
          <div style="font-size: 64px; margin-bottom: 20px; animation: bounce 0.6s;">üéâ</div>
          <h2 style="margin: 0 0 10px; font-size: 28px; font-weight: 600;">Pronto!</h2>
          <p style="margin: 0 0 20px; font-size: 18px; opacity: 0.95;">
            "${propertyName}" foi criada com sucesso!
          </p>
          <p style="margin: 0; font-size: 16px; opacity: 0.8;">
            Redirecionando para o dashboard...
          </p>
          <style>
            @keyframes bounce {
              0%, 100% { transform: translateY(0); }
              50% { transform: translateY(-20px); }
            }
          </style>
        `;
      },
      close: () => {
        overlay.remove();
      }
    };
  }

  async function createProperty() {
    const btnCreate = document.getElementById('btn-create');
    btnCreate.disabled = true;
    btnCreate.textContent = 'Criando...';

    const progress = showProgressModal();

    let property = null;

    // === Creation block: any error here means creation failed and should alert ===
    try {
      // Step 1: Create structure (20%)
      progress.updateProgress(10, 'Criando estrutura da propriedade...');
      await new Promise(resolve => setTimeout(resolve, 300));
      progress.completeStep(1);
      progress.updateProgress(20, 'Estrutura criada!');
      
      // Step 2: Generate rooms (40%)
      progress.updateProgress(30, 'Gerando quartos...');
      await new Promise(resolve => setTimeout(resolve, 400));
      progress.completeStep(2);
      progress.updateProgress(40, 'Quartos criados!');
      
      // Step 3: Create guests (60%)
      progress.updateProgress(50, 'Criando h√≥spedes de exemplo...');
      await new Promise(resolve => setTimeout(resolve, 300));
      progress.completeStep(3);
      progress.updateProgress(60, 'H√≥spedes criados!');
      
      // Step 4: Generate reservations (80%)
      progress.updateProgress(70, 'Gerando reservas...');
      await new Promise(resolve => setTimeout(resolve, 400));
      progress.completeStep(4);
      progress.updateProgress(80, 'Reservas criadas!');
      
      // Step 5: Save everything (100%)
      progress.updateProgress(90, 'Salvando dados...');
      property = await wizard.createProperty();
      property.modules = wizard.data.modules || [];
      progress.completeStep(5);
      progress.updateProgress(100, 'Conclu√≠do!');
      
      // Show success message
      await new Promise(resolve => setTimeout(resolve, 300));
      progress.showSuccess(property.name);
      
      // Wait a bit then close progress UI
      await new Promise(resolve => setTimeout(resolve, 2000));
      progress.close();

      // Persist created property to NexefiiProps (compat shim) and to user session
      try {
        const propRecord = Object.assign({}, property, { key: property.key || property.slug });
        if (window.NexefiiProps && typeof window.NexefiiProps.upsertProperty === 'function') {
          window.NexefiiProps.upsertProperty(propRecord);
        } else {
          // Fallback: write directly to localStorage under nexefii_properties
          try {
            const m = JSON.parse(localStorage.getItem('nexefii_properties') || '{}');
            m[propRecord.key] = propRecord;
            localStorage.setItem('nexefii_properties', JSON.stringify(m));
          } catch (e) { /* ignore */ }
        }

        // Also add to current user properties and persist session for Nexefii compatibility
        try {
          const sessionKey = 'nexefii_session';
          const altSessionKey = 'nexefii_session';
          let session = null;
          try { session = JSON.parse(localStorage.getItem(sessionKey) || 'null'); } catch(e) { session = null; }
          if (!session) {
            try { session = JSON.parse(localStorage.getItem(altSessionKey) || 'null'); } catch(e) { session = null; }
          }
          if (!session) session = window.NEXEFII.currentUser || { properties: [] };
          session.properties = session.properties || [];
          // avoid duplicates by key
          if (!session.properties.some(p => p.key === propRecord.key || p.slug === propRecord.slug)) {
            session.properties.push({ id: propRecord.id || propRecord.key, key: propRecord.key, slug: propRecord.slug, name: propRecord.name });
          }
          localStorage.setItem(sessionKey, JSON.stringify(session));
          localStorage.setItem(altSessionKey, JSON.stringify(session));
          window.NEXEFII.currentUser = session;
          // Publish selection for opener/master-control to consume
          try {
            const selectKey = propRecord.key || propRecord.id || propRecord.slug;
            if (selectKey) {
              try { localStorage.setItem('nexefii_wizard_selected_property', selectKey); } catch(e){}
              try { localStorage.setItem('nexefii_active_property', selectKey); } catch(e){}
              if (window.SessionContext && typeof window.SessionContext.setActiveProperty === 'function') {
                try { SessionContext.setActiveProperty(selectKey); } catch(e){}
              }
            }
          } catch(e) { /* best-effort, ignore */ }
        } catch (e) { console.warn('[Wizard] session persist failed', e); }
      } catch (e) { console.warn('[Wizard] upsert property failed', e); }

      console.log('[Wizard] Property created successfully:', property);

    } catch (error) {
      // Creation failed: close progress and surface an alert to the user
      console.error('[Wizard] Error creating property:', error);
      try { progress.close(); } catch(_) {}
      alert(`‚úñ Erro ao criar propriedade:\n\n${error && error.message ? error.message : error}`);
      btnCreate.disabled = false;
      try {
        const text = window.NEXEFII?.i18n ? window.NEXEFII.i18n.t('wizard.buttons.create') : '‚ú® Criar Propriedade';
        btnCreate.textContent = text;
      } catch(_) { btnCreate.textContent = '‚ú® Criar Propriedade'; }
      return; // stop flow ‚Äî do not attempt navigation
    }

    // === Navigation block: errors here should NOT show the creation alert ===
    try {
      (function safeNavigateToMaster() {
        // prefer slug but fallback to other identifiers
        const slug = (property && (property.slug || property.propertySlug || property.propertyId || property.id || property.key));
        const paramVal = slug ? String(slug) : '';
        const params = new URLSearchParams();
        if (paramVal) params.set('selectedProperty', paramVal);
        const target = '/master-control.html' + (params.toString() ? ('?' + params.toString()) : '');
        try {
          const maybeRouter = window.NEXEFII && window.NEXEFII.router;
          if (maybeRouter && typeof maybeRouter.navigate === 'function') {
            try { maybeRouter.navigate(target); return; } catch(e) { /* fallback below */ }
          }
          if (window.Nexefii && typeof window.Nexefii.navigate === 'function') { try { window.Nexefii.navigate(target); return; } catch(e){} }
          if (window.app && typeof window.app.navigate === 'function') { try { window.app.navigate(target); return; } catch(e){} }
          if (window.navigation && typeof window.navigation.navigate === 'function') { try { window.navigation.navigate(target); return; } catch(e){} }
          window.location.href = target;
        } catch (e) {
          console.warn('[Wizard] Navigation fallback failed, redirecting via location', e);
          window.location.href = target;
        }
      })();
    } catch (navErr) {
      console.error('[Wizard] Navigation after property creation failed:', navErr);
      // Do not show creation alert here ‚Äî keep user on modal and log the navigation error.
    }
  }
  // Registrar globalmente para acesso externo (shell.html)
  window.createProperty = createProperty;

  // ============================================================================
  // Initialize
  // ============================================================================

  async function initWizardPage() {
    console.log('[Wizard] Initializing wizard page');
    // Ensure every translatable element has a stable default text attribute so
    // we can restore it if translations are missing or incorrect. This helps
    // avoid showing raw i18n keys (e.g., 'wizard.step6.basicInfo') in the UI.
    try {
      const scopeAll = document.querySelector('.wizard-page');
      if (scopeAll) {
        scopeAll.querySelectorAll('[data-i18n]').forEach(el => {
          try {
            if (!el.hasAttribute('data-i18n-default')) {
              el.setAttribute('data-i18n-default', (el.textContent || '').trim());
            }
          } catch (_) {}
        });
      }
    } catch (e) { /* non-critical */ }

    // Wait for the global i18n helper to be available (race with shell/router load).
    // If it's already present this resolves immediately. Timeout after 1500ms and continue.
    function waitForI18n(timeoutMs = 1500) {
      return new Promise((resolve) => {
        if (window.NEXEFII && window.NEXEFII.i18n) return resolve(window.NEXEFII.i18n);
        const start = Date.now();
        const iv = setInterval(() => {
          if (window.NEXEFII && window.NEXEFII.i18n) {
            clearInterval(iv);
            return resolve(window.NEXEFII.i18n);
          }
          if (Date.now() - start > timeoutMs) {
            clearInterval(iv);
            return resolve(null);
          }
        }, 50);
      });
    }
    
    // Prepare timezone data and rendering functions (two-level selects)
    // tzData is the authoritative list of timezone ids and default labels (kept here for now)
    const tzData = [
        {
          key: 'americas',
          options: [
            { value: 'America/New_York', label: 'Nova York (UTC-5)' },
            { value: 'America/Los_Angeles', label: 'Los Angeles (UTC-8)' },
            { value: 'America/Chicago', label: 'Chicago (UTC-6)' },
            { value: 'America/Denver', label: 'Denver (UTC-7)' },
            { value: 'America/Toronto', label: 'Toronto (UTC-5)' },
            { value: 'America/Sao_Paulo', label: 'S√£o Paulo (UTC-3)' },
            { value: 'America/Manaus', label: 'Manaus (UTC-4)' },
            { value: 'America/Rio_Branco', label: 'Rio Branco (UTC-5)' },
            { value: 'America/Fortaleza', label: 'Fortaleza (UTC-3)' },
            { value: 'America/Buenos_Aires', label: 'Buenos Aires (UTC-3)' },
            { value: 'America/Santiago', label: 'Santiago (UTC-3)' },
            { value: 'America/Lima', label: 'Lima (UTC-5)' },
            { value: 'America/Bogota', label: 'Bogot√° (UTC-5)' },
            { value: 'America/Mexico_City', label: 'Cidade do M√©xico (UTC-6)' },
            { value: 'America/Caracas', label: 'Caracas (UTC-4)' }
          ]
        },
        {
          key: 'europe',
          options: [
            { value: 'Europe/London', label: 'Londres (UTC+0)' },
            { value: 'Europe/Paris', label: 'Paris (UTC+1)' },
            { value: 'Europe/Berlin', label: 'Berlim (UTC+1)' },
            { value: 'Europe/Madrid', label: 'Madri (UTC+1)' },
            { value: 'Europe/Rome', label: 'Roma (UTC+1)' },
            { value: 'Europe/Amsterdam', label: 'Amsterd√£ (UTC+1)' },
            { value: 'Europe/Brussels', label: 'Bruxelas (UTC+1)' },
            { value: 'Europe/Zurich', label: 'Zurique (UTC+1)' },
            { value: 'Europe/Lisbon', label: 'Lisboa (UTC+0)' },
            { value: 'Europe/Moscow', label: 'Moscou (UTC+3)' }
          ]
        },
        {
          key: 'asiaPacific',
          options: [
            { value: 'Asia/Tokyo', label: 'T√≥quio (UTC+9)' },
            { value: 'Asia/Shanghai', label: 'Xangai (UTC+8)' },
            { value: 'Asia/Hong_Kong', label: 'Hong Kong (UTC+8)' },
            { value: 'Asia/Singapore', label: 'Singapura (UTC+8)' },
            { value: 'Asia/Seoul', label: 'Seul (UTC+9)' },
            { value: 'Asia/Dubai', label: 'Dubai (UTC+4)' },
            { value: 'Asia/Bangkok', label: 'Bangkok (UTC+7)' },
            { value: 'Asia/Kolkata', label: 'Mumbai (UTC+5:30)' },
            { value: 'Australia/Sydney', label: 'Sydney (UTC+10)' },
            { value: 'Australia/Melbourne', label: 'Melbourne (UTC+10)' },
            { value: 'Pacific/Auckland', label: 'Auckland (UTC+12)' }
          ]
        },
        {
          key: 'africaMiddleEast',
          options: [
            { value: 'Africa/Cairo', label: 'Cairo (UTC+2)' },
            { value: 'Africa/Johannesburg', label: 'Joanesburgo (UTC+2)' },
            { value: 'Africa/Lagos', label: 'Lagos (UTC+1)' },
            { value: 'Asia/Jerusalem', label: 'Jerusal√©m (UTC+2)' },
            { value: 'Asia/Istanbul', label: 'Istambul (UTC+3)' }
          ]
        }
      ];
      // Build fast lookup structures from tzData
    const wizardTimezoneGroups = [
      { id: 'americas', i18nKey: 'wizard.config.timezoneGroups.americas' },
      { id: 'europe', i18nKey: 'wizard.config.timezoneGroups.europe' },
      { id: 'asiaPacific', i18nKey: 'wizard.config.timezoneGroups.asiaPacific' },
      { id: 'africaMiddleEast', i18nKey: 'wizard.config.timezoneGroups.africaMiddleEast' }
    ];

    const wizardTimezoneCities = {};
    tzData.forEach(g => {
      wizardTimezoneCities[g.key] = (g.options || []).map(o => ({ id: o.value, defaultLabel: o.label }));
    });

    function translateKey(i18nKey, fallback) {
      try {
        if (window.NEXEFII && window.NEXEFII.i18n) {
          const t = window.NEXEFII.i18n.t(i18nKey);
          if (t && t !== i18nKey) return t;
        }
      } catch (e) {}
      // fallback to page-local resolver if available
      try {
        const pageTxt = resolveI18nKey(i18nKey, (window.NEXEFII?.i18n?.getLanguage?.() || navigator.language || 'pt'));
        if (pageTxt) return pageTxt;
      } catch (e) {}
      return fallback || '';
    }

    function populateTimezoneGroups() {
      const sel = document.getElementById('timezoneGroupSelect');
      if (!sel) return;
      sel.innerHTML = '';
      wizardTimezoneGroups.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.setAttribute('data-i18n', g.i18nKey);
        const label = translateKey(g.i18nKey, g.id);
        opt.textContent = label || g.id;
        sel.appendChild(opt);
      });
    }

    function populateTimezoneCities(groupId, preserveSelected) {
      const sel = document.getElementById('timezoneSelect');
      if (!sel) return;
      const cities = wizardTimezoneCities[groupId] || [];
      // remember current selection if requested
      const current = preserveSelected ? sel.value : null;
      sel.innerHTML = '';
      cities.forEach(city => {
        const opt = document.createElement('option');
        opt.value = city.id;
        const i18nKey = 'wizard.config.timezoneCities.' + city.id;
        opt.setAttribute('data-i18n', i18nKey);
        opt.setAttribute('data-i18n-default', city.defaultLabel || city.id);
        const label = translateKey(i18nKey, city.defaultLabel || city.id) || city.id;
        opt.textContent = label;
        sel.appendChild(opt);
      });
      // try to restore previous selection if it still exists
      if (current) {
        const found = Array.from(sel.options).some(o => { if (o.value === current) { sel.value = current; return true;} return false; });
        if (!found && sel.options.length) sel.selectedIndex = 0;
      } else {
        // set a reasonable default: prefer Sao_Paulo if available, otherwise first
        const prefer = 'America/Sao_Paulo';
        if (Array.from(sel.options).some(o => o.value === prefer)) sel.value = prefer;
        else if (sel.options.length) sel.selectedIndex = 0;
      }
    }

    // Wire change on group -> repopulate cities
    (function wireTimezoneSelectors() {
      const g = document.getElementById('timezoneGroupSelect');
      const c = document.getElementById('timezoneSelect');
      if (!g || !c) return;
      g.addEventListener('change', (e) => {
        populateTimezoneCities(e.target.value, false);
      });
    })();

    function findGroupForTimezone(tzId) {
      if (!tzId) return null;
      for (const key of Object.keys(wizardTimezoneCities)) {
        if ((wizardTimezoneCities[key] || []).some(c => c.id === tzId)) return key;
      }
      return null;
    }

    // Try to wait briefly for i18n to be ready so the page is translated on first render.
    const i18n = await waitForI18n();
    if (i18n) {
      try {
        // Capture default/fallback text for elements with data-i18n so we can
        // restore them if the translation is missing (some bundles return the
        // key itself when a translation is absent).
        const scope = document.querySelector('.wizard-page');
        const defaults = new Map();
        if (scope) {
          scope.querySelectorAll('[data-i18n]').forEach(el => {
            try {
              const key = el.getAttribute('data-i18n');
              const attrDefault = el.getAttribute('data-i18n-default');
              const textDefault = (el.textContent || '').trim();
              defaults.set(key, attrDefault || textDefault);
            } catch(_) {}
          });
        }

        // Apply translations to the wizard immediately (best-effort)
        i18n.applyToDOM(scope);

        // Restore fallback texts for keys that were not translated (t() returned the key)
        if (scope) {
          scope.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            const txt = (el.textContent || '').trim();
            if (txt === key && defaults.has(key)) {
              el.textContent = defaults.get(key);
            }
          });
        }
      } catch(e) { console.warn('[Wizard] i18n apply error at init', e); }

      // Subscribe to language changes so we re-render the group + city selects and re-apply translations
      try {
        i18n.onChange((lang) => {
          try { console.log('[Wizard] Language changed to:', lang); } catch(_){}
          // re-render page-level things that depend on translation
          try {
            const step4 = document.getElementById('step-3');
            if (step4 && step4.classList.contains('active')) {
              try { renderCategories(); } catch(_){}
            }
          } catch(_){}

          // Re-populate groups (updates group labels) and then cities preserving current selection
          try {
            const groupSel = document.getElementById('timezoneGroupSelect');
            const currentGroup = groupSel ? groupSel.value : null;
            populateTimezoneGroups();
            // restore group selection if possible
            if (groupSel && currentGroup) groupSel.value = currentGroup;
            const activeGroup = groupSel && groupSel.value ? groupSel.value : (findGroupForTimezone(document.getElementById('timezoneSelect')?.value) || 'americas');
            populateTimezoneCities(activeGroup, true);
          } catch (e) { console.warn('[Wizard] timezone repopulate failed', e); }

          // Re-apply translations to DOM, preserving defaults for missing keys
          try {
            const scope = document.querySelector('.wizard-page');
            const defaults = new Map();
            if (scope) {
              scope.querySelectorAll('[data-i18n]').forEach(el => {
                try {
                  const key = el.getAttribute('data-i18n');
                  const attrDefault = el.getAttribute('data-i18n-default');
                  const textDefault = (el.textContent || '').trim();
                  defaults.set(key, attrDefault || textDefault);
                } catch(_) {}
              });
            }
            i18n.applyToDOM(scope);
            if (scope) {
              scope.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const txt = (el.textContent || '').trim();
                if (txt === key && defaults.has(key)) {
                  el.textContent = defaults.get(key);
                }
              });
            }
          } catch(e) { /* ignore */ }
        });
      } catch(e) { console.warn('[Wizard] failed to subscribe to i18n changes', e); }
    } else {
      console.warn('[Wizard] I18n not available (timed out)');
    }

    // Ensure group + city selects are populated on initial load
    try {
      populateTimezoneGroups();
      // attempt to infer initial group from a preserved value or prefer 'americas'
      const initialTZ = (function(){ try { return null; } catch(_) { return null; } })();
      const inferredGroup = findGroupForTimezone(initialTZ) || 'americas';
      const groupSel = document.getElementById('timezoneGroupSelect');
      if (groupSel) groupSel.value = inferredGroup;
      populateTimezoneCities(inferredGroup, false);
    } catch(e) { console.warn('[Wizard] populateTimezone selects failed', e); }
    
    updateUI();

    // After UI update, sanitize any elements that still contain raw i18n keys
    // (defensive) ‚Äî replace with the data-i18n-default attribute or a
    // humanized version of the key.
    function humanizeKey(key) {
      if (!key) return '';
      // prefer last token after dot
      const last = key.split('.').pop();
      // split camelCase and underscores/dashes
      const spaced = last.replace(/([a-z])([A-Z])/g, '$1 $2')
                        .replace(/[_-]+/g, ' ')
                        .replace(/\b([a-z])/g, s => s.toUpperCase());
      return spaced;
    }

    function sanitizeTranslatedKeys(scope) {
      try {
        const root = scope || document.querySelector('.wizard-page');
        if (!root) return;
        root.querySelectorAll('[data-i18n]').forEach(el => {
          try {
            const txt = (el.textContent || '').trim();
            const key = el.getAttribute('data-i18n');
            const def = el.getAttribute('data-i18n-default');
            // If the element text looks like an untranslated key (contains a dot
            // or starts with the key), replace it with the default or a human
            // friendly label.
            if (!txt) return;
            if (txt === key || /\b[a-z]+\.[a-z0-9_.-]+/i.test(txt) || txt.includes('.') ) {
              if (def && def.length) {
                el.textContent = def;
              } else {
                el.textContent = humanizeKey(key);
              }
            }
          } catch (_) {}
        });
      } catch (_) {}
    }

    // run once now
    sanitizeTranslatedKeys();
  }

  // Initialize wizard page when loaded
  initWizardPage();

[console:log] [Wizard] Initializing wizard page
[console:log] [I18n] Legacy monolithic loaded for seeding
[console:log] [Shell] Executing inline script: 
  // Wizard integration helper: when the wizard completes, call `wizardSelectProperty(propId)`
  (function(){
    window.wizardSelectProperty = function(propId){
      try {
        if (!propId) return;
        // Persist selection so opener can react via storage event
        localStorage.setItem('nexefii_wizard_selected_property', String(propId));
        // Also set active property for this window/session
        try { localStorage.setItem('nexefii_active_property', String(propId)); } catch(e){}
        // Close the wizard window if it was opened as a popup
        try { if (window.opener) { window.close(); return; } } catch(e){}
        // If not popup, navigate back to master-control to show result (include selectedProperty)
        try {
          const slug = String(propId || '');
          const params = new URLSearchParams();
          if (slug) params.set('selectedProperty', slug);
          const target = '/master-control.html' + (params.toString() ? ('?' + params.toString()) : '');
          try { location.href = target; } catch(e) { /* ignore */ }
        } catch(e) { /* ignore */ }
      } catch(e){ console.warn('[Wizard] wizardSelectProperty error', e); }
    };

    // Best-effort: attach to common finish button ids/classes if present
    document.addEventListener('DOMContentLoaded', function(){
      var btn = document.getElementById('wizardFinish') || document.querySelector('[data-action="wizard-finish"]') || document.querySelector('.wizard-finish');
      if (btn) {
        btn.addEventListener('click', function(ev){
          try {
            // attempt to read a property id input
            var inp = document.querySelector('[name="propertyId"]') || document.getElementById('propertyId');
            var val = inp ? (inp.value || inp.dataset && inp.dataset.value) : null;
            if (val) window.wizardSelectProperty(val);
          } catch(e){ /* ignore */ }
        });
      }
    });
  })();

[console:log] [Shell] Page loaded successfully: wizard
[console:log] [Router] Route handler executed JSHandle@object
[console:log] [I18n] Segment loaded: common (pt)
[console:log] [I18n] Segment loaded: wizard (pt)
[console:log] [I18n] Segment loaded: dashboard (pt)
[console:log] [I18n] Segment loaded: rooms (pt)
[console:log] [I18n] Segment loaded: frontdesk (pt)
[console:log] [I18n] Segment loaded: reservations (pt)
[console:log] [I18n] Segment loaded: common (en)
[console:log] [I18n] Segment loaded: wizard (en)
[console:log] [I18n] Segment loaded: dashboard (en)
[console:log] [I18n] Segment loaded: rooms (en)
[console:log] [I18n] Segment loaded: frontdesk (en)
[console:log] [I18n] Segment loaded: reservations (en)
[console:log] [I18n] Segment loaded: common (es)
[console:log] [I18n] Segment loaded: wizard (es)
[console:log] [I18n] Segment loaded: dashboard (es)
[console:log] [I18n] Segment loaded: rooms (es)
[console:log] [I18n] Segment loaded: frontdesk (es)
[console:log] [I18n] Segment loaded: reservations (es)
[console:log] [I18n] Languages ready: JSHandle@array
[console:log] [I18n] Applied translations to 120 elements (only real translations or defaults replaced)
[console:startGroup] [Wizard][i18n] Diagnostics
[console:log] NEXEFII.i18n present: true
[console:log] i18n currentLang: en
[console:log] i18n translations keys: JSHandle@array
[console:log] __PAGE_I18N keys: JSHandle@array
[console:log] language selector value: en
[console:log] [Wizard][i18n] Found translations for 'en', applying to DOM.
[console:log] [I18n] Applied translations to 120 elements (only real translations or defaults replaced)
[console:endGroup] console.groupEnd
[fatal] ProtocolError: Protocol error (Runtime.callFunctionOn): Promise was collected
    at <instance_members_initializer> (R:\Development\Projects\nexefii\node_modules\puppeteer-core\lib\cjs\puppeteer\common\CallbackRegistry.js:103:14)
    at new Callback (R:\Development\Projects\nexefii\node_modules\puppeteer-core\lib\cjs\puppeteer\common\CallbackRegistry.js:107:16)
    at CallbackRegistry.create (R:\Development\Projects\nexefii\node_modules\puppeteer-core\lib\cjs\puppeteer\common\CallbackRegistry.js:25:26)
    at Connection._rawSend (R:\Development\Projects\nexefii\node_modules\puppeteer-core\lib\cjs\puppeteer\cdp\Connection.js:108:26)
    at CdpCDPSession.send (R:\Development\Projects\nexefii\node_modules\puppeteer-core\lib\cjs\puppeteer\cdp\CdpSession.js:74:33)
    at #evaluate (R:\Development\Projects\nexefii\node_modules\puppeteer-core\lib\cjs\puppeteer\cdp\ExecutionContext.js:363:50)
    at ExecutionContext.evaluate (R:\Development\Projects\nexefii\node_modules\puppeteer-core\lib\cjs\puppeteer\cdp\ExecutionContext.js:277:36)
    at IsolatedWorld.evaluate (R:\Development\Projects\nexefii\node_modules\puppeteer-core\lib\cjs\puppeteer\cdp\IsolatedWorld.js:100:30)
    at CdpFrame.evaluate (R:\Development\Projects\nexefii\node_modules\puppeteer-core\lib\cjs\puppeteer\api\Frame.js:362:43)
    at CdpFrame.<anonymous> (R:\Development\Projects\nexefii\node_modules\puppeteer-core\lib\cjs\puppeteer\util\decorators.js:109:27)